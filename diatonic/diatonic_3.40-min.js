if(!window.DIATONIC){window.DIATONIC={}}if(!window.DIATONIC.map){window.DIATONIC.map={}}DIATONIC.map.accordionMaps=[];DIATONIC.map.key2number={C:0,"C♯":1,"D♭":1,D:2,"D♯":3,"E♭":3,E:4,F:5,"F♯":6,"G♭":6,G:7,"G♯":8,"A♭":8,A:9,"A♯":10,"B♭":10,B:11};DIATONIC.map.number2key=["C","C♯","D","E♭","E","F","F♯","G","G♯","A","B♭","B"];DIATONIC.map.number2key_br=["Dó","Dó♯","Ré","Mi♭","Mi","Fá","Fá♯","Sol","Sol♯","Lá","Si♭","Si"];DIATONIC.map.Units={BTNSIZE:52,BTNRADIUS:26,BTNSPACE:3,FONTSIZE:18};DIATONIC.map.loadAccordionMaps=function(c,a){var b=0;for(var d=0;d<c.length;d++){b++;FILEMANAGER.register("MAP");$.getJSON(c[d],{format:"json"}).done(function(e){FILEMANAGER.deregister("MAP",true);DIATONIC.map.accordionMaps.push(new DIATONIC.map.AccordionMap(e))}).fail(function(g,h,e){FILEMANAGER.deregister("MAP",false);var f=h+", "+e;console.log("Accordion Load Failed:\nLoading: "+g.responseText.substr(1,40)+"...\nError:\n "+f)}).always(function(){b--;if(b===0&&a){a()}})}};if(!window.DIATONIC){window.DIATONIC={}}if(!window.DIATONIC.map){window.DIATONIC.map={}}DIATONIC.map.AccordionMap=function(b,a){this.id=b.id;this.menuOrder=b.menuOrder;this.model=b.model;this.tuning=b.tuning;this.buttons=b.buttons;this.image=b.image||"img/accordion.default.gif";this.keyboard=new DIATONIC.map.Keyboard(b.keyboard,b.pedal);this.songPathList=b.songPathList;this.practicePathList=b.practicePathList;this.chordPathList=b.chordPathList;this.localResource=a||false;this.songs={items:{},sortedIndex:[]};this.practices={items:{},sortedIndex:[]};this.chords={items:{},sortedIndex:[]};if(!this.localResource){this.songs=this.loadABCX(this.songPathList);this.chords=this.loadABCX(this.chordPathList);this.practices=this.loadABCX(this.practicePathList)}};DIATONIC.map.AccordionMap.prototype.getId=function(){return this.id};DIATONIC.map.AccordionMap.prototype.getFullName=function(){return this.getTxtModel()+" "+this.getTxtTuning()+" - "+this.getTxtNumButtons()};DIATONIC.map.AccordionMap.prototype.getTxtModel=function(){return this.model};DIATONIC.map.AccordionMap.prototype.getTxtNumButtons=function(){var b=this.buttons;var e="";for(var d=b.length-1;d>0;d--){e="/"+b[d]+e}return b[0]+e};DIATONIC.map.AccordionMap.prototype.getTxtTuning=function(){var b=this.tuning;var e="";for(var d=b.length-1;d>0;d--){e="/"+b[d]+e}return b[0]+e};DIATONIC.map.AccordionMap.prototype.getPathToImage=function(){return this.image};DIATONIC.map.AccordionMap.prototype.getChord=function(a){return this.chords.items[a]};DIATONIC.map.AccordionMap.prototype.setChord=function(a,b,c){this.chords.items[a]=b;if(c){this.chords.sortedIndex.push(a)}};DIATONIC.map.AccordionMap.prototype.getSong=function(a){return this.songs.items[a]};DIATONIC.map.AccordionMap.prototype.setSong=function(a,b,c){this.songs.items[a]=b;if(c){this.songs.sortedIndex.push(a)}};DIATONIC.map.AccordionMap.prototype.getPractice=function(a){return this.practices.items[a]};DIATONIC.map.AccordionMap.prototype.setPractice=function(a,b,c){this.practices.items[a]=b;if(c){this.practices.sortedIndex.push(a)}};DIATONIC.map.AccordionMap.prototype.getFirstSong=function(){var a=this.songs.sortedIndex[0]||"";return a};DIATONIC.map.AccordionMap.prototype.getFirstPractice=function(){var a=this.practices.sortedIndex[0]||"";return a};DIATONIC.map.AccordionMap.prototype.getFirstChord=function(){var a=this.chords.sortedIndex[0]||"";return a};DIATONIC.map.AccordionMap.prototype.loadABCX=function(f,a){var d=0;var e;var c={items:{},sortedIndex:[]};for(var b=0;b<f.length;b++){d++;FILEMANAGER.register("ABCX");e=f[b];$.get(e).done(function(h){FILEMANAGER.deregister("ABCX",true);var i=new ABCXJS.TuneBook(h);for(var g=0;g<i.tunes.length;g++){c.items[i.tunes[g].title]=i.tunes[g].abc;c.sortedIndex.push(i.tunes[g].title)}}).fail(function(i,j,g){FILEMANAGER.deregister("ABCX",false);var h=j+", "+g;console.log("ABCX Load Failed:\nLoading: "+i.responseText.substr(1,40)+"...\nError:\n "+h)}).always(function(){d--;if(d===0){c.sortedIndex.sort();if(a){a()}}})}return c};if(!window.DIATONIC){window.DIATONIC={}}if(!window.DIATONIC.map){window.DIATONIC.map={}}DIATONIC.map.Keyboard=function(b,a){this.pedalInfo=a;this.layout=b.layout;this.keys=b.keys;this.basses=b.basses;this.noteToButtonsOpen={};this.noteToButtonsClose={};this.legenda={};this.baseLine={};this.limits={minX:10000,minY:10000,maxX:0,maxY:0};this.BTNRADIUS=DIATONIC.map.Units.BTNRADIUS;this.BTNSIZE=DIATONIC.map.Units.BTNSIZE;this.BTNSPACE=DIATONIC.map.Units.BTNSPACE;this.FONTSIZE=DIATONIC.map.Units.FONTSIZE;this.setup(b)};DIATONIC.map.Keyboard.prototype.setup=function(n){var r,p,e,d;var q=n.keys.open.length;var o=n.basses.open.length;this.keyMap=new Array();this.modifiedItems=new Array();var a=0;for(g=0;g<q;g++){this.keyMap[g]=new Array(n.keys.open[g].length);a=Math.max(n.keys.open[g].length,a)}var k=n.basses.open[0].length;for(g=q;g<q+o;g++){this.keyMap[g]=new Array(n.basses.open[g-q].length)}this.width=(q+o+1)*(this.BTNSIZE+this.BTNSPACE)+this.BTNSPACE*2;this.height=(a)*(this.BTNSIZE+this.BTNSPACE)+this.BTNSIZE/2;d=this.BTNSPACE*4+(((a-k)/2))*(this.BTNSIZE+this.BTNSPACE);var c,m,l,h;for(var f=0;f<this.keyMap.length;f++){if(f<q){r=this.BTNSPACE+(f+0.6)*(this.BTNSIZE+this.BTNSPACE);e=(this.BTNSPACE*4)+(this.getLayout(f)+0.5)*(this.BTNSIZE+this.BTNSPACE);c=n.keys.open[f];m=n.keys.close[f];l=false}else{r=this.BTNSPACE+(f+1.4)*(this.BTNSIZE+this.BTNSPACE);e=d+0.5*(this.BTNSIZE+this.BTNSPACE);c=n.basses.open[f-q];m=n.basses.close[f-q];l=true}for(var g=0;g<this.keyMap[f].length;g++){p=e+g*(this.BTNSIZE+this.BTNSPACE);this.limits.minX=Math.min(this.limits.minX,r);this.limits.minY=Math.min(this.limits.minY,p);this.limits.maxX=Math.max(this.limits.maxX,r);this.limits.maxY=Math.max(this.limits.maxY,p);var b=new DIATONIC.map.Button(r,p,{pedal:this.isPedal(g,f)});b.tabButton=(g+1)+Array(f+1).join("'");b.openNote=this.parseNote(c[g],l);b.closeNote=this.parseNote(m[g],l);b.setText(false);h=this.getNoteVal(b.openNote);if(!this.noteToButtonsOpen[h]){this.noteToButtonsOpen[h]=[]}this.noteToButtonsOpen[h].push(b.tabButton);h=this.getNoteVal(b.closeNote);if(!this.noteToButtonsClose[h]){this.noteToButtonsClose[h]=[]}this.noteToButtonsClose[h].push(b.tabButton);this.keyMap[f][g]=b}}r=this.BTNSPACE+(q+0.5)*(this.BTNSIZE+this.BTNSPACE);p=d-0.5*(this.BTNSIZE+this.BTNSPACE);this.baseLine={x:r,yi:p,yf:p+5*(this.BTNSIZE+this.BTNSPACE)};this.legenda=new DIATONIC.map.Button(this.limits.maxX-(this.BTNRADIUS+this.BTNSPACE),this.limits.minY+(this.BTNRADIUS+this.BTNSPACE),{openLabel:"Abre",closeLabel:"Fecha",radius:36,pedal:true,fontsize:14,xLabel:0,textAnchor:"middle",color:"#828282"})};DIATONIC.map.Keyboard.prototype.getButtons=function(b){var a=this.getNoteVal(b);return{open:this.noteToButtonsOpen[a],close:this.noteToButtonsClose[a]}};DIATONIC.map.Keyboard.prototype.getNoteVal=function(a){return DIATONIC.map.key2number[a.key.toUpperCase()]+(a.isBass?(a.isChord?-12:0):a.octave*12)};DIATONIC.map.Keyboard.prototype.print=function(f,c){c=c||{};f.innerHTML="";this.paper=Raphael(f,"100%","100%");c.scale=c.scale||1;
c.mirror=c.mirror||false;c.transpose=c.transpose||false;c.label=c.label||false;this.legenda.draw(this.paper,this.limits,c);this.legenda.setOpen();this.legenda.setClose();if(c.transpose){this.paper.setSize(this.height*c.scale,this.width*c.scale);f.style.height=(this.width+8)*c.scale+"px";f.style.width=this.height*c.scale+"px";var e=c.mirror?this.baseLine.x:this.limits.maxX-(this.baseLine.x-this.limits.minX);for(var a=e-10;a<=e+10;a+=10){this.drawLine(this.baseLine.yi*c.scale,a*c.scale,this.baseLine.yf*c.scale,a*c.scale)}}else{this.paper.setSize(this.width*c.scale,this.height*c.scale);f.style.height=this.height*c.scale+"px";f.style.width=this.width*c.scale+"px";var e=c.mirror?this.limits.maxX-(this.baseLine.x-this.limits.minX):this.baseLine.x;for(var a=e-10;a<=e+10;a+=10){this.drawLine(a*c.scale,this.baseLine.yi*c.scale,a*c.scale,this.baseLine.yf*c.scale)}}for(var b=0;b<this.keyMap.length;b++){for(var d=0;d<this.keyMap[b].length;d++){this.keyMap[b][d].draw(this.paper,this.limits,c)}}};DIATONIC.map.Keyboard.prototype.drawLine=function(a,b,c,d){this.paper.path(["M",a,b,"L",c,d]).attr({fill:"none",stroke:"black","stroke-width":1})};DIATONIC.map.Keyboard.prototype.getLayout=function(a){return this.layout[a]||0};DIATONIC.map.Keyboard.prototype.isPedal=function(b,a){return(this.pedalInfo[1]===(b+1))&&(this.pedalInfo[0]===(a+1))};DIATONIC.map.Keyboard.prototype.parseNote=function(e,c){var d={};var b=e.split(":");var a=b[0].charAt(b[0].length-1);d.key=parseInt(a)?b[0].replace(a,""):b[0];d.octave=parseInt(a)?parseInt(a):4;d.complement=b[1]?b[1]:"";d.value=DIATONIC.map.key2number[d.key.toUpperCase()];d.isChord=(d.key===d.key.toLowerCase());d.isBass=c;d.isMinor=d.complement.substr(0,2).indexOf("m")>=0;d.isSetima=d.complement.substr(0,2).indexOf("7")>=0;if(typeof(d.value)==="undefined"){throw new Error("Nota inválida: "+e)}return d};DIATONIC.map.Keyboard.prototype.redraw=function(d){for(var a=0;a<this.keyMap.length;a++){for(var c=0;c<this.keyMap[a].length;c++){var b=this.keyMap[a][c];b.setText(d.label)}}};DIATONIC.map.Keyboard.prototype.clear=function(c){c=true;if(c){for(var a=0;a<this.keyMap.length;a++){for(var b=0;b<this.keyMap[a].length;b++){this.keyMap[a][b].clear()}}}else{for(var b=0;b<this.modifiedItems.length;b++){this.modifiedItems[b].clear()}}this.modifiedItems=new Array()};if(!window.DIATONIC){window.DIATONIC={}}if(!window.DIATONIC.map){window.DIATONIC.map={}}Raphael.fn.arc=function(b,a,g,f,d,c,h){var e=[d,c,h,0,1,g,f].join(" ");return this.path("M"+b+" "+a+" a "+e)};Raphael.fn.circularArc=function(c,b,f,g,a){var e=c+f*Math.cos(g*Math.PI/180);var d=b+f*Math.sin(g*Math.PI/180);var i=c+f*Math.cos(a*Math.PI/180);var h=b+f*Math.sin(a*Math.PI/180);return this.arc(e,d,i-e,h-d,f,f,0)};DIATONIC.map.Button=function(a,d,b){var c=b||{};this.x=a;this.y=d;this.paper=null;this.openNote=null;this.closeNote=null;this.closeSide=null;this.openSide=null;this.closeNoteKey=null;this.openNoteKey=null;this.tabButton=null;this.openColor=c.openColor||"#00ff00";this.closeColor=c.closeColor||"#00b2ee";this.openLabel=c.openLabel||"";this.closeLabel=c.closeLabel||"";this.xLabel=c.xLabel||0;this.pedal=c.pedal||false;this.stroke=this.pedal?2:1;this.textAnchor=c.textAnchor||"middle";this.color=c.color||(c.pedal?"red":"black");this.BTNRADIUS=c.radius||DIATONIC.map.Units.BTNRADIUS;this.FONTSIZE=c.fontsize||DIATONIC.map.Units.FONTSIZE};DIATONIC.map.Button.prototype.draw=function(g,d,c){var b,a,e,f;if(c.transpose){b=this.y;a=c.mirror?this.x:d.maxX-(this.x-d.minX)}else{b=c.mirror?d.maxX-(this.x-d.minX):this.x;a=this.y}b*=c.scale;a*=c.scale;e=this.BTNRADIUS*c.scale;f=this.FONTSIZE*c.scale;this.paper=g||this.paper;this.circle=this.paper.circle(b,a,e);this.circle.attr({fill:"white",stroke:"white","stroke-width":0});this.closeSide=this.paper.circularArc(b,a,e,170,350);this.closeSide.attr({fill:"none",stroke:"none","stroke-width":0});this.openSide=this.paper.circularArc(b,a,e,350,170);this.openSide.attr({fill:"none",stroke:"none","stroke-width":0});this.closeNoteKey=this.paper.text(b+(this.xLabel*c.scale),a-(12*c.scale),this.closeLabel).attr({"text-anchor":this.textAnchor,"font-family":"Sans Serif","font-size":f});this.openNoteKey=this.paper.text(b+(this.xLabel*c.scale),a+(12*c.scale),this.openLabel).attr({"text-anchor":this.textAnchor,"font-family":"Sans Serif","font-size":f});this.paper.circle(b,a,e).attr({fill:"none",stroke:this.color,"stroke-width":this.stroke});this.paper.path(["M",b-e,a+(5*c.scale),"L",b+e,a-(5*c.scale)]).attr({fill:"none",stroke:this.color,"stroke-width":this.stroke});this.setText(c.label)};DIATONIC.map.Button.prototype.clear=function(a){if(!this.closeSide){return}var b=this;if(a){window.setTimeout(function(){b.clear()},a*1000);return}this.openSide.attr({fill:"none",stroke:"none","stroke-width":0});this.closeSide.attr({fill:"none",stroke:"none","stroke-width":0})};DIATONIC.map.Button.prototype.setOpen=function(a){if(!this.openSide){return}var b=this;if(a){window.setTimeout(function(){b.setOpen()},a*1000);return}this.openSide.attr({fill:this.openColor,stroke:this.openColor,"stroke-width":0})};DIATONIC.map.Button.prototype.setClose=function(a){if(!this.closeSide){return}var b=this;if(a){window.setTimeout(function(){b.setClose()},a*1000);return}this.closeSide.attr({fill:this.closeColor,stroke:this.closeColor,"stroke-width":0})};DIATONIC.map.Button.prototype.getLabel=function(c,b){var a="";if(b){a=DIATONIC.map.number2key_br[c.value]}else{a=DIATONIC.map.number2key[c.value]}if(b){a=a.toUpperCase()+""}if(c.isChord){a=a.toLowerCase()+""}if(c.isMinor){a+="-"}return a};DIATONIC.map.Button.prototype.getLabelOld=function(c,b){var a="";if(c.isChord){a=DIATONIC.map.number2key[c.value].toLowerCase()+""}else{if(b){a=DIATONIC.map.number2key_br[c.value]}else{a=DIATONIC.map.number2key[c.value]}}if(c.isMinor){a+="-"}return a};DIATONIC.map.Button.prototype.setText=function(a){if(this.openNote){this.setTextOpen(this.getLabel(this.openNote,a));this.setTextClose(this.getLabel(this.closeNote,a))}};DIATONIC.map.Button.prototype.setTextClose=function(a){this.closeLabel=a;if(this.closeNoteKey){this.closeNoteKey.attr("text",this.closeLabel)}};DIATONIC.map.Button.prototype.setTextOpen=function(a){this.openLabel=a;if(this.openNoteKey){this.openNoteKey.attr("text",this.openLabel)}};