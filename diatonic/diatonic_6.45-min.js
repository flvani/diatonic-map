window.DIATONIC||(window.DIATONIC={}),window.DIATONIC.map||(window.DIATONIC.map={}),DIATONIC.map.color={},DIATONIC.map.color.fill="none",DIATONIC.map.color.background="none",DIATONIC.map.color.open="#00ff00",DIATONIC.map.color.close="#00b2ee",DIATONIC.map.loadAccordionMaps=function(t,e,i){DIATONIC.map.accordionMaps||(DIATONIC.map.accordionMaps=[]);for(var s=0,o=0;o<t.length;o++)s++,FILEMANAGER.register("MAP"),$.getJSON(t[o],{format:"json"}).done(function(t){FILEMANAGER.deregister("MAP",!0),DIATONIC.map.accordionMaps.push(new DIATONIC.map.AccordionMap(t,!1,e))}).fail(function(t,e,i){FILEMANAGER.deregister("MAP",!1);e=e+", "+i;waterbug.log("Accordion Load Failed:\nLoading: "+t.responseText.substr(1,40)+"...\nError:\n "+e)}).always(function(){0===--s&&(DIATONIC.map.sortAccordions(),i)&&i()})},DIATONIC.map.sortAccordions=function(){DIATONIC.map.accordionMaps.sort(function(t,e){return parseInt(t.menuOrder)-parseInt(e.menuOrder)})},window.DIATONIC||(window.DIATONIC={}),window.DIATONIC.map||(window.DIATONIC.map={}),DIATONIC.map.AccordionMap=function(t,e,i){this.id=t.id,this.menuOrder=t.menuOrder,this.model=t.model,this.tuning=t.tuning,this.buttons=t.buttons,this.image=t.image||"images/accordions/accordion.default.gif",this.keyboard=new DIATONIC.map.Keyboard(t.keyboard,t.pedal,i),this.songPathList=t.songPathList,this.practicePathList=t.practicePathList,this.chordPathList=t.chordPathList,this.localResource=e||!1,this.songs={items:{},sortedIndex:[]},this.practices={items:{},sortedIndex:[]},this.chords={items:{},sortedIndex:[]},this.localResource||(this.songs=this.loadABCX(this.songPathList),this.chords=this.loadABCX(this.chordPathList),this.practices=this.loadABCX(this.practicePathList))},DIATONIC.map.AccordionMap.prototype.getId=function(){return this.id},DIATONIC.map.AccordionMap.prototype.getFullName=function(){return this.getTxtModel()+" "+this.getTxtTuning()+" - "+this.getTxtNumButtons()},DIATONIC.map.AccordionMap.prototype.getTxtModel=function(){return this.model},DIATONIC.map.AccordionMap.prototype.getTxtNumButtons=function(){for(var t=this.buttons,e="",i=t.length-1;0<i;i--)e="/"+t[i]+e;return t[0]+e},DIATONIC.map.AccordionMap.prototype.getTxtTuning=function(){for(var t=this.tuning,e="",i=t.length-1;0<i;i--)e="/"+t[i]+e;return t[0]+e},DIATONIC.map.AccordionMap.prototype.getPathToImage=function(){return this.image},DIATONIC.map.AccordionMap.prototype.getAbcText=function(t,e){return this[t].items[e]},DIATONIC.map.AccordionMap.prototype.setSong=function(t,e,i){this.songs.items[t]=e,i&&this.songs.sortedIndex.push(t)},DIATONIC.map.AccordionMap.prototype.getFirstSong=function(){return this.songs.sortedIndex[0]||""},DIATONIC.map.AccordionMap.prototype.getFirstPractice=function(){return this.practices.sortedIndex[0]||""},DIATONIC.map.AccordionMap.prototype.getFirstChord=function(){return this.chords.sortedIndex[0]||""},DIATONIC.map.AccordionMap.prototype.loadABCX=function(t,e){for(var s,i=0,a={items:{},ids:{},details:{},sortedIndex:[]},o=0;o<t.length;o++)i++,FILEMANAGER.register("ABCX"),s=t[o],$.get(s).done(function(t){FILEMANAGER.deregister("ABCX",!0);for(var e=new ABCXJS.TuneBook(t),i=0;i<e.tunes.length;i++){var s=e.tunes[i],o=s.id,n=!1;"h"===o.toLowerCase().charAt(0)&&(o=o.substr(1),n=!0),a.ids[o]=s.title,a.items[s.title]=s.abc,a.details[s.title]={composer:s.composer,id:o,hidden:n},a.sortedIndex.push(s.title)}}).fail(function(t,e,i){FILEMANAGER.deregister("ABCX",!1);e=e+", "+i;t&&void 0!==t.responseText?waterbug.log("ABCX Load Failed:\nLoading: "+t.responseText.substr(1,40)+"...\nError:\n "+e):waterbug.log("ABCX Load Failed:\nLoading: "+s+"...\nError:\n "+e)}).always(function(){0===--i&&(a.sortedIndex.sort(),e)&&e()});return a},window.DIATONIC||(window.DIATONIC={}),window.DIATONIC.map||(window.DIATONIC.map={}),DIATONIC.map.Keyboard=function(t,e,i){this.pedalInfo=e,this.layout=t.layout,this.keys=t.keys,this.basses=t.basses,this.noteToButtonsOpen={},this.noteToButtonsClose={},this.legenda={},this.baseLine={},this.opts=i||{},this.divs={container:null,pane:null,imagem:null,extras:null,rotateBtnExtra:null,globeBtnExtra:null,openBtnRight:null},this.rowsNumbered=!1,this.numerica=t.numerica||null,this.pautaNumerica=0,this.pautaNumericaMini=!0,this.pautaNumericaFormato=null,this.limits={minX:1e4,minY:1e4,maxX:0,maxY:0},this.radius=26,this.size=2*this.radius+4,this.setup(t)},DIATONIC.map.Keyboard.prototype.setup=function(t){for(var e,i,s,o=t.keys.open.length,n=t.basses.open.length,a=(this.keyMap=new Array,this.modifiedItems=new Array,0),r=0;r<o;r++)this.keyMap[r]=new Array(t.keys.open[r].length),a=Math.max(t.keys.open[r].length,a);var h=t.basses.open[0].length;for(r=o;r<o+n;r++)this.keyMap[r]=new Array(t.basses.open[r-o].length);this.opts.isApp?this.width=(o+n)*this.size+21+3:this.width=(o+n)*this.size+this.size+3,this.height=a*this.size+3;var p,d,l,m=(4===h?4:3)*this.size;m+=(a-11)/2*this.size;for(var u=0;u<this.keyMap.length;u++)for(var c=u<o?(e=(u+.5)*this.size,s=this.getLayout(u)*this.size,p=t.keys.open[u],d=t.keys.close[u],!1):(e=this.opts.isApp?(u+.5)*this.size+21:(u+.5)*this.size+this.size,s=m,p=t.basses.open[u-o],d=t.basses.close[u-o],!0),r=0;r<this.keyMap[u].length;r++){i=s+(r+.5)*this.size,this.limits.minX=Math.min(this.limits.minX,e),this.limits.minY=Math.min(this.limits.minY,i),this.limits.maxX=Math.max(this.limits.maxX,e),this.limits.maxY=Math.max(this.limits.maxY,i);var g=new DIATONIC.map.Button(this,e-this.radius,i-this.radius,{radius:this.radius,isPedal:this.isPedal(r,u)});g.tabButton=r+1+Array(u+1).join("'"),g.openNote=this.parseNote(p[r],c),g.closeNote=this.parseNote(d[r],c),l=this.getNoteVal(g.openNote),this.noteToButtonsOpen[l]||(this.noteToButtonsOpen[l]=[]),this.noteToButtonsOpen[l].push(g.tabButton),l=this.getNoteVal(g.closeNote),this.noteToButtonsClose[l]||(this.noteToButtonsClose[l]=[]),this.noteToButtonsClose[l].push(g.tabButton),this.keyMap[u][r]=g}e=this.opts.isApp?o*this.size+12:o*this.size+this.size/2,i=m-.5*this.size,this.baseLine={x:e,yi:i,yf:i+(h+1)*this.size};this.legenda=new DIATONIC.map.Button(this,this.limits.maxX-(40+this.radius),this.limits.minY+40,{radius:40,borderWidth:2})},DIATONIC.map.Keyboard.prototype.reprint=function(){void 0!==this.reprintData&&this.print(this.reprintData.Div,this.reprintData.Accordion)},DIATONIC.map.Keyboard.prototype.print=function(t,e){this.reprintData={Div:t,Accordion:e};var i=e.render_opts,s=e.translator,o=(t.innerHTML="",this.divs.container=t,document.createElement("div")),n=(o.setAttribute("id","keyboardPaneDiv"),o.setAttribute("class","keyboardPane"),this.divs.pane=o,t.appendChild(o),document.createElement("div")),n=(n.setAttribute("id","keyboardImagemDiv"),n.setAttribute("class","keyboard-imagem"),this.divs.imagem=n,t.appendChild(n),this.divs.imagem.innerHTML='<img src="'+e.loaded.image+'" title="'+e.getFullName()+" "+SITE.translator.getResource("keys")+'">',this.divs.imagem.style.scale=i.scale,document.createElement("div")),e=(n.setAttribute("id","keyboardExtraBtnDiv"),n.setAttribute("class","keyboard-extras"),this.divs.extras=n,t.appendChild(n),this.divs.extras.innerHTML='<button id="rotateBtnExtra" data-translate="rotate" ><i class="ico-rotate" ></i></button>        <button id="globeBtnExtra"  data-translate="globe" ><i class="ico-world" ></i></button>        <button id="openBtnRight"  data-translate="PrefsPropsCKkeyboardAlignRight" style="display:none;"><i class="ico-open-right"></i></button>',this.divs.extras.style.scale=i.scale,this.divs.rotateBtnExtra=document.getElementById("rotateBtnExtra"),this.divs.globeBtnExtra=document.getElementById("globeBtnExtra"),this.divs.openBtnRight=document.getElementById("openBtnRight"),this.paper=new SVG.Printer(o),this.paper.initDoc("keyb","Diatonic Map Keyboard",'.keyboardPane {\n        padding:4px;\n        background-color:none;\n    }\n    .blegenda,\n    .button {\n        font-family: sans-serif, arial;\n        text-anchor: middle;\n        font-size: 16px;\n        font-weight: bold;\n        text-shadow: 0.5px 0.5px #ddd, -0.5px -0.5px 0 #ddd, 0.5px -0.5px 0 #ddd, -0.5px 0.5px 0 #ddd;\n    }\n    .keyboard-imagem {\n        position: absolute;\n        display: none;\n        border-radius: 50%;\n        background: rgba(100, 100, 100, 0.5);\n        box-shadow: 0 0 15px 15px rgba(100, 100, 100, 0.5);\n        height: 80px;\n        width: 80px;\n    }\n    .keyboard-imagem img {\n        border: none;\n        margin-top: -5px;\n        margin-left: -10px;\n        height: 100px;\n        width: 100px;\n    }\n    .keyboard-extras {\n        position: absolute;\n        display: none;\n        margin-top: 2px;\n        margin-left: 5px;\n        font-family: "abcx";\n        height: 40px;\n        width: fit-content;\n        font-size: 16px;\n        margin: 0;\n        padding: 1px;\n        pointer-events: auto;\n        background-color: none;\n    }\n    .keyboard-extras label,\n    .keyboard-extras button {\n        position: relative;\n        display: block;\n        float: left;\n        text-align: left;\n        font-family: Milonga, Arial;\n        font-weight: normal;\n        font-size: 32px;\n        line-height: 32px;\n        height: 44px;\n        width: auto;\n        text-shadow: 2px 1px 2px rgba(50, 50, 50, 0.8);\n        left: 0;\n        margin: 0;\n        margin-left: 4px;\n        padding: 4px;\n        outline: none !important;\n        border: none;\n        color: #ff9922;\n        color: red;\n        background-color: transparent;\n        border-radius: 50%;\n    }\n    .keyboard-extras button:hover {\n        height: 44px;\n        background: lavender;\n        cursor: pointer;\n    }\n    .buttonN {\n        font-family: sans-serif, arial;\n        text-anchor: middle;\n        font-size: 24px;\n        font-weight: bold;\n        text-shadow: 0.5px 0.5px #ddd, -0.5px -0.5px 0 #ddd, 0.5px -0.5px 0 #ddd, -0.5px 0.5px 0 #ddd;\n    }\n    .buttonNMini {\n        font-family: "AllertaStencil", "RobotoItalic";\n        text-anchor: middle;\n        font-size: 11px;\n        font-weight: normal;\n    }\n    .blegenda {\n        font-weight: normal;\n        font-size: 12px;\n    }',i),this.paper.initPage(i.scale),ABCXJS.parse.clone(i)),a=(e.kls="blegenda",e.klsN="buttonN",e.klsNMini="buttonNMini",e.pautaNumerica=!1,this.legenda.draw("l00",this.paper,this.limits,e),this.opts.isApp?7:10);if(i.transpose){for(var r={w:this.height,h:this.width},h=(p=i.mirror?this.baseLine.x:this.limits.maxX-(this.baseLine.x-this.limits.minX)+2)-a;h<=p+a;h+=a)this.drawLine(this.baseLine.yi,h,this.baseLine.yf,h);i.mirror?(this.divs.extras.style.top="",this.divs.extras.style.left="1px",this.divs.extras.style.bottom=61*i.scale+"px",this.divs.extras.style.width=40*i.scale+"px",this.divs.extras.style.right="",this.divs.imagem.style.top="",this.divs.imagem.style.left="",this.divs.imagem.style.bottom=25*i.scale+"px"):(this.divs.extras.style.top="1px",this.divs.extras.style.left="1px",this.divs.extras.style.width=40*i.scale+"px",this.divs.extras.style.bottom="",this.divs.extras.style.right="",this.divs.imagem.style.top=25*i.scale+"px",this.divs.imagem.style.left="",this.divs.imagem.style.bottom=""),this.divs.imagem.style.right=25*i.scale+"px"}else{r={w:this.width,h:this.height};for(var p,h=(p=i.mirror?this.limits.maxX-(this.baseLine.x-this.limits.minX)+2:this.baseLine.x)-a;h<=p+a;h+=a)this.drawLine(h,this.baseLine.yi,h,this.baseLine.yf);i.mirror?(this.divs.extras.style.top="1px",this.divs.extras.style.left="1px",this.divs.extras.style.bottom="",this.divs.extras.style.right="",this.divs.imagem.style.top="",this.divs.imagem.style.left=25*i.scale+"px",this.divs.imagem.style.bottom=25*i.scale+"px",this.divs.imagem.style.right=""):(this.divs.extras.style.top="1px",this.divs.extras.style.left="",this.divs.extras.style.bottom="",this.divs.extras.style.right="1px",this.divs.imagem.style.top="",this.divs.imagem.style.left="",this.divs.imagem.style.bottom=25*i.scale+"px",this.divs.imagem.style.right=25*i.scale+"px")}var d=ABCXJS.parse.clone(i);d.kls="button",d.klsN="buttonN",d.klsNMini="buttonNMini",d.pautaNumerica=0<this.pautaNumerica,d.pautaNumericaMini=this.pautaNumericaMini;for(var l=0;l<this.keyMap.length;l++)for(var m=0;m<this.keyMap[l].length;m++)this.keyMap[l][m].draw("b"+l+m,this.paper,this.limits,d);this.paper.endPage(r),this.paper.endDoc(),this.divs.pane.style.height=this.divs.pane.clientHeight-8+"px",this.divs.container.style.height=this.divs.pane.clientHeight+"px",this.legenda.setSVG(i.label,{pull:"Pull",push:"Push",translator:s});for(l=0;l<this.keyMap.length;l++)for(m=0;m<this.keyMap[l].length;m++)this.keyMap[l][m].setSVG(i.label,{formatoNumerico:this.pautaNumericaFormato,mini:this.pautaNumericaMini})},DIATONIC.map.Keyboard.prototype.setTabFormat=function(t){var e=t%2,t=(t-e)/2;0==t?(SITE.properties.options.tabShowOnlyNumbers=!1,this.rowsNumbered=SITE.properties.options.rowsNumbered=1==e,this.pautaNumerica=0,this.pautaNumericaMini=!0):(SITE.properties.options.tabShowOnlyNumbers=1==e,this.rowsNumbered=SITE.properties.options.rowsNumbered=!1,this.numerica?(this.pautaNumerica=t,this.pautaNumericaFormato=this.numerica[t-1],this.pautaNumericaMini=!SITE.properties.options.tabShowOnlyNumbers):(this.pautaNumerica=0,this.pautaNumericaMini=!0,this.pautaNumericaFormato=null))},DIATONIC.map.Keyboard.prototype.drawLine=function(t,e,i,s){this.paper.printLine(t,e,i,s)},DIATONIC.map.Keyboard.prototype.getButtons=function(t){t=this.getNoteVal(t);return{open:this.noteToButtonsOpen[t],close:this.noteToButtonsClose[t]}},DIATONIC.map.Keyboard.prototype.getNoteVal=function(t){let e=0;return t.isBass&&t.isChord&&(e=-12,t.isMinor&&(e-=12),t.isSetima)&&(e-=24),ABCXJS.parse.key2number[t.key.toUpperCase()]+(t.isBass?e:12*t.octave)},DIATONIC.map.Keyboard.prototype.getLayout=function(t){return this.layout[t]||0},DIATONIC.map.Keyboard.prototype.showImagem=function(t){this.divs.imagem.style.display=t?"block":"none"},DIATONIC.map.Keyboard.prototype.showExtras=function(t){this.divs.extras.style.display=t?"inline":"none"},DIATONIC.map.Keyboard.prototype.showExtrasOpen=function(t){this.divs.openBtnRight.style.display=t?"block":"none"},DIATONIC.map.Keyboard.prototype.isPedal=function(t,e){return this.pedalInfo[1]===t+1&&this.pedalInfo[0]===e+1},DIATONIC.map.Keyboard.prototype.parseNote=function(t,e){var i={key:void 0,value:void 0,octave:4,isBass:!1,isChord:!1,isMinor:!1,isSetima:!1},s=t,o=0<=s.indexOf("m"),n=0<=s.indexOf("7"),a=s.charAt(s.length-1);if(e&&(s=s.replace(":",""),o&&(s=s.replace("m","")),n&&(s=s.replace("7","")),i.isBass=e,i.isChord=s===s.toLowerCase(),i.isMinor=o,i.isSetima=n,a=s.charAt(s.length-1)),i.key=parseInt(a)?s.replace(a,""):s,i.variant=this.getVariant(i.key.charAt(i.key.length-1)),0<i.variant&&(i.key=i.key.substring(0,i.key.length-1)),i.octave=parseInt(a)?parseInt(a):4,i.value=ABCXJS.parse.key2number[i.key.toUpperCase()],void 0===i.value)throw new Error("Nota inválida: "+t);return i},DIATONIC.map.Keyboard.prototype.getVariant=function(t){switch(t){case"¹":return 1;case"²":return 2;case"³":return 3;default:return 0}},DIATONIC.map.Keyboard.prototype.redraw=function(t){for(var e=0;e<this.keyMap.length;e++)for(var i=0;i<this.keyMap[e].length;i++)!this.pautaNumericaMini&&this.keyMap[e][i].isNumerica||this.keyMap[e][i].setText(t.label)},DIATONIC.map.Keyboard.prototype.clear=function(t){for(var e=0;e<this.keyMap.length;e++)for(var i=0;i<this.keyMap[e].length;i++)this.keyMap[e][i].clear();this.modifiedItems=new Array},window.DIATONIC||(window.DIATONIC={}),window.DIATONIC.map||(window.DIATONIC.map={}),DIATONIC.map.Button=function(t,e,i,s){s=s||{};this.kb=t,this.x=e,this.y=i,this.openNote=null,this.closeNote=null,this.tabButton=null,this.SVG={gid:0},this.radius=s.radius,this.isPedal=s.isPedal||!1,this.borderWidth=s.borderWidth||(this.isPedal?2:1),this.borderColor=s.borderColor||(this.isPedal?"red":"black")},DIATONIC.map.Button.prototype.draw=function(t,e,i,s){var o,i=s.transpose?(o=this.y,s.mirror?this.x:i.maxX-2*this.radius-(this.x-i.minX)):(o=s.mirror?i.maxX-2*this.radius-(this.x-i.minX):this.x,this.y);(s=s||{}).radius=this.radius,s.borderColor=this.borderColor,s.borderWidth=this.borderWidth,s.fillColor=s.kls&&"blegenda"===s.kls?"none":DIATONIC.map.color.fill,s.openColor=s.kls&&"blegenda"===s.kls?DIATONIC.map.color.open:"none",s.closeColor=s.kls&&"blegenda"===s.kls?DIATONIC.map.color.close:"none",this.closeNote&&this.closeNote.isBass&&(s.pautaNumerica=!1),this.isNumerica=s.pautaNumerica,this.SVG.gid=e.printButton(t,o,i,s)},DIATONIC.map.Button.prototype.clear=function(t){var e;this.SVG.button&&(e=this,t?window.setTimeout(function(){e.clear()},1e3*t):(this.SVG.closeArc.style.setProperty("fill","none"),this.SVG.openArc.style.setProperty("fill","none")))},DIATONIC.map.Button.prototype.setOpen=function(t){var e;this.SVG.button&&(e=this,t?window.setTimeout(function(){e.setOpen()},1e3*t):this.SVG.openArc.style.setProperty("fill",DIATONIC.map.color.open))},DIATONIC.map.Button.prototype.setClose=function(t){var e;this.SVG.button&&(e=this,t?window.setTimeout(function(){e.setClose()},1e3*t):this.SVG.closeArc.style.setProperty("fill",DIATONIC.map.color.close))},DIATONIC.map.Button.prototype.setSVG=function(t,e){var i,s=this.SVG,o=0,n=e.pull||null,a=e.push||null,r=e.translator||null,h=e.formatoNumerico||null,e=e.mini;this.SVG.button=document.getElementById(s.gid),this.SVG.openArc=document.getElementById(s.gid+"_ao"),this.SVG.closeArc=document.getElementById(s.gid+"_ac"),this.SVG.openText=document.getElementById(s.gid+"_to"),this.SVG.closeText=document.getElementById(s.gid+"_tc"),this.SVG.numericText=document.getElementById(s.gid+"_tn"),this.SVG.numericTextMini=document.getElementById(s.gid+"_tm"),this.isNumerica&&(o=h.overrides[this.tabButton]||(s=parseInt(this.tabButton),i=(this.tabButton.match(/'/g)||[]).length,s+h.rule[i]),e?this.SVG.numericTextMini.textContent=o:this.SVG.numericText.textContent=o),this.isNumerica&&!e||(r?(this.SVG.openText.setAttribute("data-translate",n),this.SVG.closeText.setAttribute("data-translate",a),this.setText(t,r.getResource(n),r.getResource(a))):this.setText(t,n,a))},DIATONIC.map.Button.prototype.setText=function(t,e,i){this.SVG.openText&&(this.SVG.openText.textContent=e||this.getLabel(this.openNote,t),this.SVG.closeText.textContent=i||this.getLabel(this.closeNote,t))},DIATONIC.map.Button.prototype.getLabel=function(t,e){var i=t.key;return e&&(i=i.toUpperCase()+"",i=ABCXJS.parse.key2br[i].toUpperCase()),t.isChord&&(i=i.toLowerCase()+""),t.isMinor&&(i+="-"),t.isSetima&&(i+="7"),i};