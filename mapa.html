<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
teste.
-->
<html>
    <head>
        <title>Mapa para Acordeons Diatônicos</title>
        <meta charset="UTF-8" />
        <link rel="icon" type="image/icon" href="images/favicon.ico"/>
        <meta name="viewport" content="height=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0" />
        
        <link rel="stylesheet" href="fontsIco/abcx.css" />
        <link rel="stylesheet" href="fontsGoogle/fonts.css" />
        
        <link rel="stylesheet" href="css/styles4abcx.css" />
        
        <link rel="stylesheet" href="css/mapa.css" />
        <link rel="stylesheet" href="css/studio.css" >
        
        
  </head>
    <body>
        
        <script type="text/javascript" src="proto_noconflict.js" ></script>
        <script type="text/javascript" src="jquery/jquery-1.11.1.min.js"></script>
        
        <!-- suporte a MIDI -->
        <script type="text/javascript" src="jslib/MIDI.js"></script>
        
        <script type="text/javascript" src="jslib/html5kellycolorpicker.js"></script>
        
        <!-- suporte a arquivos -->
        <script type="text/javascript" src="file/filemanager.js"></script>
        
        <!-- suporte a arquivos ABC -->
        <script id="mainABCX" type="text/javascript" src="abcxjs/abcxjs.js" ></script>
        
        <!-- suporte mapas de acordeons -->
        <script type="text/javascript" src="diatonic/diatonic.js"></script>
        
        <script type="text/javascript" src="languages/language.js"></script>
        
        <script type="text/javascript" src="ace4abcx/ace4abcx.js"></script>
        
        
        <script type="text/javascript" src="site/mapa.js"></script>
        <script type="text/javascript" src="site/estudio.js"></script>
        

        <div id="topBar" class="topBar gradiente" >
            <span id="DR_appName" class="topTitle">Mapa para Acordeons Diatônicos</span>
            <a id="topSettings" class="topSettings" title="Ajustes"><i class="ico-cogs" ></i></a>
            <div class="dropdown-group">
                <input id="fileLoadMap" type="file" accept="text/abc" multiple="multiple" style="display: none;"/>
                <input id="fileLoadRepertoire" type="file" accept="text/abcx, text/abc" multiple="multiple" style="display: none;"/>
                <div id="mapMenu" class="topMenu"></div>
            </div>
        </div> <!-- topBar -->
        <div id="mapaDiv" class="mapaDiv">
            <div id="section1" class="tabs">
                <input type="radio" checked="checked" />
                <label id="a_nome_gaita">...</label>
                <div class="btn-group">
                    <button id="buttonChangeNotation" >
                        <i class="ico-world-2"></i>&nbsp;<span id="DR_chlabel">Mudar a notação</span>
                    </button>
                    <button id="buttonShowMedia" style="display:none;" >
                        <i class="ico-vplayer"></i>&nbsp;<span id="DR_showmedia">Videoaula</span>
                    </button>
                </div>
                <div class="tv-content-always">
                    <div id="contentKeyboard" style="position: relative; top: 0; left: 0; padding-right: 130px; padding-bottom: 10px; min-height: 180px; height: auto; width: auto;" ></div>
                    <div id="td_imagem_gaita" style="position: absolute; top: 0; right: 0; margin-right: 15px;"></div>
                    <div id="divABCXversion"  style="font-family: 'abcFont'; color: rgba(0,0,0,0.8); font-size:12px; position: absolute; bottom: 2px; right: 5px;"></div>
                </div>
            </div>
            
            <div id="mapaWarningsDiv"></div>

            <div id="section2" class="tabs">
                <input id="tabChords" type="radio" name="tabControl" class="tab-selector-1" />
                <label for="tabChords" class="tab-label-1">Acordes</label>

                <input id="tabPractices" type="radio" name="tabControl" class="tab-selector-2" />
                <label for="tabPractices" class="tab-label-2">Exercícios</label>

                <input id="tabSongs" type="radio" name="tabControl" class="tab-selector-3" />
                <label for="tabSongs" class="tab-label-3">Músicas</label>

                <div class="btn-group" >
                    <div id="menuChords" class="topMenu" style="display:none;"></div>
                    <div id="menuPractices" class="topMenu" style="display:none;"></div>
                    <div id="menuSongs" class="topMenu" style="display:none;"></div>
                    <button id="buttonTools">
                        <i class="ico-wrench"></i>&#160;<span id="DR_tools">Ferramentas</span>
                    </button>
                    <button id="buttonPrinter" >
                        <i class="ico-printer"></i>&#160;<span id="DR_print">Imprimir</span>
                    </button>
                    <button id="buttonPlay" ><i class="ico-play"></i></button>
                    <button id="buttonStop" ><i class="ico-stop"></i></button>
                    <label id="currentPlayTimeLabel" >00:00:00</label>
                </div>

                <div id="tuneContainerDiv" class="tv-content customScrollBar">
                    <div class="tv-content-1">
                        <div id="tabChordsDiv"></div>
                    </div>
                    <div class="tv-content-2" >
                        <div id="tabPracticesDiv" ></div>
                    </div>
                    <div class="tv-content-3">
                        <div id="tabTunesDiv"></div>    
                    </div>    
                </div>
            </div>
        </div> <!-- mapaDiv -->
        <div id="studioDiv" class="studioDiv" ></div>
        <div id="studioControlDiv" style="display:none;">
            <div id="controlDiv1" class="btn-subgroup" >
                <button id="showEditorBtn" title="Exibir/Ocultar Editor"><i id="I_showEditor" class="ico-folder"></i>&#160;<span id="DR_showEditor">Editor</span></button>
                <button id="showMapBtn" title="Exibir/Ocultar Teclado"><i id="I_showMap" class="ico-folder"></i>&#160;<span id="DR_showMap">Teclado</span></button>
                <button id="printBtn2" title="Imprimir" ><i class="ico-printer"></i>&#160;Imprimir</button>
                <button id="saveBtn" title="Salvar Local" ><i class="ico-download"></i>&#160;Salvar Local</button>
                <button id="forceRefresh" title="Atualizar" ><i class="ico-bolt"></i>&#160;Atualizar</button>
                <button id="modeBtn" title="Modo normal/didático" ><i class="ico-listening" ></i></button>
                <button id="timerBtn" title="Timer"><i class="ico-timer-00" ></i></button>
                <button id="GClefBtn" title="Melodia"><i class="ico-clef-treble" ></i></button>
                <button id="FClefBtn" title="Baixos"><i class="ico-clef-bass" ></i></button>
                <input  style="display: none;" type="checkbox" id="chkAutoRefresh" /><span style="display: none;" id="DR_refresh">Auto atualização</span> 
                <!--input type="checkbox" id="chkDebug" onclick="javascript:doCheckDebug();" /><span id="DR_debug">Depurar</span-->
            </div>
            <div id="divDidacticPlayControls"  class="btn-subgroup" style="display: none;" >
                <input id="gotoMeasureBtn" type="text" title="Ir para o compasso" value="Ir para..."/>
                <b>..</b>
                <input id="untilMeasureBtn" type="text" title="Executar até o compasso" value="até..."/>
                <button id="stepBtn" title="Passo a passo">&#160;<i class="ico-play"></i>&#160;</button>
                <button id="stepMeasureBtn" title="Executar compasso">&#160;<i class="ico-forward"></i>&#160;</button>
                <button id="repeatBtn" title="Repetir">&#160;<i class="ico-repeat-cw"></i>&#160;</button>
                <button id="clearBtn" title="Limpar">&#160;<i class="ico-stop"></i>&#160;</button>
                <button id="tempoBtn" title="Andamento">&#160;&#160;1&#160;&#160;</button>
            </div>
            <div id="divNormalPlayControls" class="btn-subgroup" >
                <button id="playBtn2" title="Executar">&#160;<i class="ico-play"></i>&#160;</button>
                <button id="stopBtn2" title="Parar">&#160;<i class="ico-stop"></i>&#160;</button>
            </div>
            <label id="currentPlayTimeLabel2" >00:00:00</label>
        </div>  <!-- controlDiv - este bloco é tratado internamente -->  
        <div id="printPreviewDiv" class="printPreviewClass"></div>
        
        <script id="mainScript" type="text/javascript">
            
            var siteVersion = '5.00'; // definir automaticamente
            var abcxVersion = getABCXversion(); // Obtem e mostra a versão corrente da lib ABCX 
            var debug=false;
            
            var myMap;
            var myStudio;

            function ga(){
                console.log('Funcao ga não definida - para enganar o google');
            }

            window.addEventListener( 'load', initApp );
                    

            window.onblur = function() {
                if( !myStudio || !myMap ) return;
                
                if(myStudio.visible) {
                    if( myStudio.midiPlayer.playing) {
                        myStudio.startPlay('normal'); // pause
                    }
                } else {
                    if( myMap.midiPlayer.playing) {
                        myMap.startPlay('normal'); // pause
                    }
                }
            };
            
            window.onresize = function() {
                if( !myStudio || !myMap ) return;
                
                if(window.getComputedStyle(myStudio.studioDiv.parent).display !== 'none') {
                    myStudio.resize();
                } else {     
                    myMap.resize();
                }    
            };
            
            document.addEventListener( 'touchend', function(event) {
                if( event.touches.length === 0 || !myStudio || !myMap ) return;
                
                if(window.getComputedStyle(myStudio.studioDiv.parent).display !== 'none') {
                    myStudio.resize();
                } else {     
                    myMap.resize();
                }    
            }, false);
            
            function initApp() {
                
                SITE.LoadProperties();
                
                if( ABCXJS.misc.isIE() ){
                    var alert = new DRAGGABLE.ui.Alert( 
                        null, null, 
                        'Notamos que você está usando o Internet Explorer.',
                        'Infelizmente, algumas funcionalidades do site não estarão disponíveis para este navegador. Assim, '+
                                ' sugerimos que você use, de preferência, os navegadores: '+
                                '<ul><li>Chrome (chromium)</li><li>Firefox</li><li>Safari</li><li>MS-Edge</li></ul>' );
                    return;
                }
        
                DR.initializeTranslator([
                    'DR_appName'
                   ,'DR_about'
                   ,'DR_layout'
                   ,'DR_espelho'
                   ,'DR_horizontal'
                   ,'DR_showText'
                   ,'DR_showEditor'
                   ,'DR_showMap'
                   ,'DR_accordions'
                   ,'DR_repertoire'
                   ,'DR_chlabel'
                   ,'DR_info'
                   ,'DR_message'
                   ,'DR_original'
                   ,'DR_localLoad'
                   ,'DR_localSave'
                   ,'DR_accordion_maps'
                   ,'DR_tablature' 
                   ,'DR_abc_format'
                   ,"DR_repeatsyms" 
                   ,'DR_abc_editor'
                   ,'tabTunes'
                   ,'tabChords'
                   ,'tabPractices'
                   ,'showTextBtn'
                   ,'showEditorBtn'
                   ,'showMapBtn' 
                   ,'modeBtn'
                   ,'timerBtn'
                   ,'playBtn'
                   ,'playBtn2'
                   ,'stopBtn'
                   ,'stopBtn2'
                   ,'tempoBtn'
                   ,'stepBtn'
                   ,'stepMeasureBtn'
                   ,'repeatBtn'
                   ,'clearBtn'
                   ,'gotoMeasureBtn'
                   ,'untilMeasureBtn'
                   ,'toolsBtn'
                   ,'pdfBtn'
                   ,'printBtn'
                   ,'printBtn2'
                   ,'saveBtn'
                   ,'forceRefresh'
                   ,'DR_refresh'
                   ,'spanTitleStudio'
                   ,'dRESTOREButtonA'
                ]);
                
                
                console.log( 
                      '\nChrome: ' + ABCXJS.misc.isChrome() 
                    + '\nCromium: ' + ABCXJS.misc.isChromium() 
                    + '\nFirefox: ' + ABCXJS.misc.isFirefox()  
                    + '\nIE: ' + ABCXJS.misc.isIE() 
                    + '\nEdge: ' + ABCXJS.misc.isEdge() 
                    + '\nOpera: ' + ABCXJS.misc.isOpera() 
                    + '\nSafari: ' + ABCXJS.misc.isSafari() + '\n '
                );
        
                w1 = new DRAGGABLE.ui.Window(
                          null
                        , null
                        , {title: '', translate: false, draggable: true, statusBar: false, top: "200px", left: "300px", zIndex: 60}
                );
                MIDI.widget = new sketch.ui.Timer({size:180, cor1:'#ff3a3a', cor2:'#ffba3b' });
                //MIDI.widget = new sketch.ui.Timer({size:180 });
                MIDI.widget.setFormat( 'Carregando...');

                DIATONIC.map.loadAccordionMaps(
                    [
                        'accordions/minuano.gc.accordion'
                       ,'accordions/minuano.bc.transportada.accordion'
                       ,'accordions/hohner.cf.club.br.accordion'
                       // 'accordions/hohner.gc.accordion'
                       //,'accordions/hohner.adg.corona.accordion'
                       //,'accordions/hohner.cf.club.accordion'
                    ]
                    , function () { 
                        FILEMANAGER.waitResources( { 
                            onProgress: function(event) {
                                if(event.success){
                                    MIDI.widget.setValue(0+Math.round(event.perc*.15));
                                    //console.log('\nPercentual: '+ event.perc + '\nTimeouts: ' + event.timeouts + '\n' + event.success );
                                } else {
                                    MIDI.widget.setValue(0+Math.round(event.perc*.15));
                                    //console.log('\nPercentual: '+ event.perc);
                                }
                            }
                            ,onLoad: loadMIDI 
                        });
                    } 
                );
            }
            
            function loadMIDI() {
                
                MIDI.loadPlugin({
                     soundfontUrl: "./soundfont/"
                    ,instruments: "accordion" // default
                    ,onprogress: function( total, done, currentPercent ) {
                        var percent = ((done*100)+currentPercent)*85/(total*100);
                        MIDI.widget.setValue(15+Math.round(percent));
                    }
                    ,callback: createMap
                });
            }
            
            function createMap() {
                
                var accordion = FILEMANAGER.loadLocal( 'property.accordion') || 'GAITA_MINUANO_GC';

                myStudio = new SITE.Estudio(
                    {   // interfaceParams
                        studioDiv: 'studioDiv'
                       ,studioControlDiv: 'studioControlDiv'
                       ,studioCanvasDiv: 'studioCanvasDiv'
                       ,generate_warnings: true
                       ,generate_midi: true
                       ,generate_tablature: 'accordion'
                       ,showMapBtn: 'showMapBtn'
                       ,showEditorBtn: 'showEditorBtn'
                       ,showTextBtn: 'showTextBtn'
                       ,printBtn:'printBtn2'
                       ,saveBtn:'saveBtn'
                       ,forceRefresh:'forceRefresh'
                       ,refreshController_id: "chkAutoRefresh"
                       ,accordion_options: {
                             id: accordion
                            ,accordionMaps: DIATONIC.map.accordionMaps
                            ,render_keyboard_opts:{transpose:false, mirror:false, scale:0.8, draggable:true, show:false, label:false}}
                       ,onchange: function( studio ) { studio.onChange(); }
                  } 
                  , {   // playerParams
                        modeBtn: "modeBtn"
                      , timerBtn: "timerBtn"
                      , playBtn: "playBtn2"
                      , stopBtn: "stopBtn2"
                      , clearBtn: "clearBtn"
                      , gotoMeasureBtn: "gotoMeasureBtn"
                      , untilMeasureBtn: "untilMeasureBtn"
                      , stepBtn: "stepBtn"
                      , repeatBtn: "repeatBtn"
                      , stepMeasureBtn: "stepMeasureBtn"
                      , tempoBtn: "tempoBtn"
                      , GClefBtn: "GClefBtn"
                      , FClefBtn: "FClefBtn"
                      , currentPlayTimeLabel: "currentPlayTimeLabel2"
                  } 
                );
        
                myMap = new SITE.Mapa(
                    {   // interfaceParams
                        ckPiano: 'checkboxPiano'
                      , ckAccordion: 'checkboxAcordeon'
                      , ckMirror: 'checkboxEspelho'
                      , ckHorizontal: 'checkboxHorizontal'
                      , btChangeNotation: 'buttonChangeNotation'
                      , accordionNamePlaceHolder: 'a_nome_gaita'
                      , accordionImagePlaceHolder: 'td_imagem_gaita'
                      , printBtn: 'buttonPrinter'
                      , toolsBtn: 'buttonTools'
                      , mapDiv: 'mapaDiv'
                      , mapMenuDiv: 'mapMenu'
                      , keyboardDiv: "contentKeyboard"
                      , tuneContainerDiv: 'tuneContainerDiv'
                      , settingsMenu:'topSettings'
                      , accordion_options: {
                             id: accordion
                            ,accordionMaps: DIATONIC.map.accordionMaps
                            ,render_keyboard_opts:{transpose:true, mirror:false, scale:1, draggable:false, show:true, label:false}}
                    }
                  , {   // tabParams
                        songSelectorParms: { tabDiv: 'tabTunesDiv', menuDiv: 'menuSongs' }
                      , chordSelectorParms:  { tabDiv: 'tabChordsDiv', menuDiv: 'menuChords' }
                      , practiceSelectorParms: { tabDiv: 'tabPracticesDiv', menuDiv: 'menuPractices' }
                      , studio: myStudio
                    }
                  , {   // playerParams
                        playBtn: "buttonPlay"
                      , stopBtn: "buttonStop"
                      , currentPlayTimeLabel: "currentPlayTimeLabel"
                    } 
                );
        
                // myMap.debugRepertorio();
            }
            
            function getABCXversion() {
                var str = document.getElementById("mainABCX").src;
                var res = str.match(/[0-9]*\.[0-9][0-9]/g);
                
                if( res ) {
                   document.getElementById("divABCXversion").innerHTML = '<i>Powered by ABCXJS version '+res[0]+'.</i>';
                   return res[0];
                } else {
                   document.getElementById("divABCXversion").innerHTML = '<i>Powered by ABCXJS debug version.</i>';
                   return false;
               }   
            }
            
        </script> <!-- mainScript -->
    </body>
</html>
