if(!window.DR){window.DR={pt_BR:0,en_US:1,de_DE:2,es_ES:3,fr_FR:4,it_IT:5,ru_RU:6}}DR.initializeTranslator=function(a){DR.agents=[];DR.extras={};DR.resource={};var b=FILEMANAGER.loadLocal("property.language");DR.language=(b?parseInt(b):DR.pt_BR);DR.createResources(a);$("#opcoes_idioma").empty();DR.createMenuOption("pt_BR","Português do Brasil");DR.loadLang(["languages/en_US.lang","languages/de_DE.lang"],DR.firstTranslation)};DR.firstTranslation=function(){if(DR.language!==DR.pt_BR&&DR.resource.DR_appName[DR.language]){DR.translate(DR.language)}};DR.translate=function(d){DR.language=d;FILEMANAGER.saveLocal("property.language",d);DR.showSelectedOption();for(var b=0;b<DR.agents.length;b++){var c=DR.agents[b];if(typeof(c)==="object"){c.translate()}else{var a=ABCXJS.parse.clone(DR.extras[c]);if(a){a.push(c)}else{a=[c]}a.forEach(function(f){var g=document.getElementById(f);if(g){var h;try{h=DR.resource[c][DR.language]}catch(i){h=DR.resource[c][0]}if(g.title){g.title=DR.resource[c][DR.language]}else{if(g.value){g.value=DR.resource[c][DR.language]}else{g.innerHTML=DR.resource[c][DR.language]}}}else{}})}}};DR.createMenuOption=function(c,b){var a=DR[c];DR.resource.DR_image[a]='<img src="img/'+c+'.png" width="32" height="32" alt="'+b+'" title="'+b+'" />';$("#opcoes_idioma").append('<li><a style="padding: 2px; width: 34px;" onclick="DR.translate(DR.'+c+');">'+DR.resource.DR_image[a]+"</a></li>")};DR.showSelectedOption=function(){document.getElementById("btn_idioma").innerHTML=DR.resource.DR_image[DR.language]};DR.getResource=function(a){try{return DR.resource[a][DR.language]?DR.resource[a][DR.language]:DR.resource[a][DR.pt_BR]}catch(b){console.log("getResource: resource '"+a+"' not found.")}};DR.setDescription=function(){var b=document.getElementsByTagName("meta");for(var a=0;a<b.length;a++){if(b[a].getAttribute("name")&&b[a].getAttribute("name")==="description"){b[a].setAttribute("content",DR.getResource("DR_description"));a=b.length}}};DR.getDescription=function(){var b=document.getElementsByTagName("meta");for(var a=0;a<b.length;a++){if(b[a].getAttribute("name")&&b[a].getAttribute("name")==="description"){return b[a].getAttribute("content")}}return""};DR.createResources=function(a){DR.resource.DR_image=[];DR.resource.DR_title=[document.title];DR.resource.DR_description=this.getDescription();DR.resource.DR_push=["Fecha"];DR.resource.DR_pull=["Abre"];DR.resource.DR_pause=["Pausar"];DR.resource.DR_wait=["Aguarde..."];DR.resource.DR_debug=["Depurar"];DR.resource.DR_octave=["Oitava"];DR.resource.DR_goto=["Ir para..."];DR.resource.DR_until=["até..."];DR.resource.DR_err_saving=["Impossível salvar"];DR.resource.DR_keys=["botões"];DR.resource.DR_save_map=["Salvar mapa corrente"];DR.resource.DR_load_map=["Carregar mapa do disco local"];for(var b=0;b<a.length;b++){DR.createResource(a[b])}};DR.createResource=function(e){var a=e.match(/([0-9])*$/g);var b=e;a=a[0];if(a){b=e.replace(a,"")}var c=document.getElementById(e);if(c===null){console.log("createResource: resource '"+e+"' undefined!");return}if(typeof(e)==="string"){if(!DR.resource[b]){DR.addAgent(b);DR.resource[b]=[]}var d;if(c.title){d=[c.title]}else{if(c.value){d=[c.value]}else{d=[c.innerHTML]}}DR.resource[b][DR.pt_BR]=d;DR.addExtra(b,a,e)}};DR.forcedResource=function(b,c,a,d){if(!DR.resource[b]){DR.addAgent(b);DR.resource[b]=[]}DR.resource[b][DR.pt_BR]=c;DR.addExtra(b,a,d)};DR.addAgent=function(a){DR.agents.push(a)};DR.addExtra=function(b,a,c){if(a){if(!DR.extras[b]){DR.extras[b]=[]}DR.extras[b].push(c)}};DR.loadLang=function(c,a){var b=0;for(var d=0;d<c.length;d++){b++;FILEMANAGER.register("LANG");$.getJSON(c[d],{format:"json"}).done(function(f){FILEMANAGER.deregister("LANG",true);DR.createMenuOption(f.id,f.langName);for(var e in f.resources){var h=DR[f.id];var g=f.resources[e];if(!DR.resource[e]){DR.addAgent(e);DR.resource[e]=[]}DR.resource[e][h]=g}}).fail(function(g,h,e){FILEMANAGER.deregister("LANG",false);var f=h+", "+e;console.log("Language Load Failed:\nLoading: "+g.responseText.substr(1,40)+"...\nError:\n "+f)}).always(function(){b--;if(b===0&&a){a()}})}};if(!window.SITE){window.SITE={}}SITE.getDate=function(){var b=new Date();var a=b.getDate();var c=b.getMonth()+1;var d=b.getFullYear();return d*10000+c*100+a};SITE.getVersion=function(a,b){var d=document.getElementById(a).src;var c=d.match(/\_[0-9]*\.[0-9]*/g);return c?b+c[0].substr(1):"debug"};SITE.LoadProperties=function(){SITE.properties=JSON.parse(FILEMANAGER.loadLocal("diatonic-map.site.properties"));if(!SITE.properties){SITE.ResetProperties()}};SITE.SaveProperties=function(){FILEMANAGER.saveLocal("diatonic-map.site.properties",JSON.stringify(SITE.properties))};SITE.ResetProperties=function(){SITE.properties={};SITE.properties.colors={useTransparency:false,highLight:"red",fill:"white",background:"none",close:"#ff3a3a",open:"#ffba3b"};SITE.properties.options={language:"pt_BR",showWarnings:true,showConsole:true,pianoSound:true,autoRefresh:false};SITE.properties.mediaDiv={visible:true,top:"100px",left:"1200px",width:300,height:300*0.55666667};SITE.properties.tabGen={abcEditor:{floating:false,maximized:false,top:"70px",left:"25px",width:"940px",height:"560px"},tabEditor:{floating:false,maximized:false,top:"140px",left:"75px",width:"940px",height:"560px"}};SITE.properties.partGen={showABCText:false,convertFromClub:false,convertToClub:false,editor:{visible:true,floating:false,maximized:false,top:"40px",left:"50px",width:"700px",height:"480px"},keyboard:{visible:false,top:"65px",left:"1200px",scale:1,mirror:true,transpose:false,label:false}};SITE.properties.studio={mode:"normal",timerOn:false,trebleOn:true,bassOn:true,editor:{visible:true,floating:false,maximized:false,top:"40px",left:"50px",width:"700px",height:"480px"},keyboard:{visible:false,top:"65px",left:"1200px",scale:1,mirror:true,transpose:false,label:false}};SITE.SaveProperties()};SITE.Mapa=function(f,a,d){var c=this;this.ypos=0;this.lastStaffGroup=-1;ABCXJS.write.color.useTransparency=SITE.properties.colors.useTransparency;ABCXJS.write.color.highLight=SITE.properties.colors.highLight;DIATONIC.map.color.fill=SITE.properties.colors.fill;DIATONIC.map.color.background=SITE.properties.colors.background;DIATONIC.map.color.close=SITE.properties.colors.close;DIATONIC.map.color.open=SITE.properties.colors.open;this.keyboardDiv=f.keyboardDiv;this.fileLoadMap=document.getElementById("fileLoadMap");this.fileLoadRepertoire=document.getElementById("fileLoadRepertoire");this.settingsMenu=document.getElementById(f.settingsMenu);this.mapDiv=document.getElementById(f.mapDiv);this.accordion=new window.ABCXJS.tablature.Accordion(f.accordion_options);this.abcParser=new ABCXJS.parse.Parse(null,this.accordion);this.midiParser=new ABCXJS.midi.Parse();this.midiPlayer=new ABCXJS.midi.Player(this);this.menu=new DRAGGABLE.ui.DropdownMenu(f.mapMenuDiv,{listener:c,method:"menuCallback"},[{title:"Acordeons",ddmId:"menuGaitas",itens:[]},{title:"Repertório",ddmId:"menuRepertorio",itens:["Restaurar o original|RESTOREREPERTOIRE","Carregar do drive local|LOADREPERTOIRE","Exportar para drive local|EXPORTREPERTOIRE","---","Extrair tablatura|PART2TAB",'Tablatura&nbsp;&nbsp;<i class="ico-open-right"></i> Partitura|TAB2PART']},{title:"Informações",ddmId:"menuInformacoes",itens:["Mapas para acordeons|MAPS","Tablaturas para acordeons|TABS","Tablaturas para gaita transportada|TABSTRANSPORTADA","Símbolos de Repetição|JUMPS","Estúdio ABCX|ESTUDIO","Formato ABCX|ABCX","Vídeo Tutoriais|TUTORIAL","Sobre|ABOUT"]}]);
this.menu.disableSubItem("menuInformacoes","ESTUDIO");this.menu.disableSubItem("menuInformacoes","ABCX");this.menu.disableSubItem("menuInformacoes","TUTORIAL");this.accordionSelector=new ABCXJS.edit.AccordionSelector("menuGaitas",this.menu,{listener:this,method:"menuCallback"},["---","Salvar mapa corrente|SAVEMAP","Carregar mapa do disco local|LOADMAP"]);var e=document.getElementsByName(a.tabRadioGroup);for(var b=0;b<e.length;b++){e[b].addEventListener("change",function(){c.showTab(this.id)})}this.tuneContainerDiv=document.getElementById(a.tuneContainerDiv);this.renderedTune={text:undefined,abc:undefined,title:undefined,tab:"songs",div:document.getElementById(a.songSelectorParms.tabDiv),selector:document.getElementById(a.songSelectorParms.menuDiv)};this.renderedChord={text:undefined,abc:undefined,title:undefined,tab:"chords",div:document.getElementById(a.chordSelectorParms.tabDiv),selector:document.getElementById(a.chordSelectorParms.menuDiv)};this.renderedPractice={text:undefined,abc:undefined,title:undefined,tab:"practices",div:document.getElementById(a.practiceSelectorParms.tabDiv),selector:document.getElementById(a.practiceSelectorParms.menuDiv)};this.playButton=document.getElementById(d.playBtn);this.stopButton=document.getElementById(d.stopBtn);this.currentPlayTimeLabel=document.getElementById(d.currentPlayTimeLabel);this.showMediaButton=document.getElementById(f.btShowMedia);this.buttonChangeNotation=document.getElementById(f.btChangeNotation);this.printButton=document.getElementById(f.printBtn);this.toolsButton=document.getElementById(f.toolsBtn);this.gaitaNamePlaceHolder=document.getElementById(f.accordionNamePlaceHolder);this.gaitaImagePlaceHolder=document.getElementById(f.accordionImagePlaceHolder);this.printButton.addEventListener("touchstart",function(g){c.printPartiture(this,g)},false);this.printButton.addEventListener("click",function(g){c.printPartiture(this,g)},false);this.toolsButton.addEventListener("touchstart",function(g){c.openEstudio(this,g)},false);this.toolsButton.addEventListener("click",function(g){c.openEstudio(this,g)},false);this.fileLoadMap.addEventListener("change",function(g){c.loadMap(g)},false);this.fileLoadRepertoire.addEventListener("change",function(g){c.carregaRepertorioLocal(g)},false);this.settingsMenu.addEventListener("click",function(g){g.preventDefault();this.blur();c.showSettings()},false);this.showMediaButton.addEventListener("click",function(){c.mediaCallback("OPEN")},false);this.buttonChangeNotation.addEventListener("click",function(g){g.preventDefault();this.blur();c.accordion.changeNotation()},false);this.playerCallBackOnScroll=function(g){c.setScrolling(g)};this.playerCallBackOnPlay=function(g){var h=g.getTime().cTime;if(c.gotoMeasureButton){c.gotoMeasureButton.value=g.currentMeasure}if(c.currentPlayTimeLabel){c.currentPlayTimeLabel.innerHTML=h}};this.playerCallBackOnEnd=function(h){var g=c.getActiveTab();c.playButton.title=DR.getResource("playBtn");c.playButton.innerHTML='<i class="ico-play"></i>';g.abc.midi.printer.clearSelection();c.accordion.clearKeyboard(true);if(c.currentPlayTimeLabel){c.currentPlayTimeLabel.innerHTML="00:00.00"}};this.playButton.addEventListener("click",function(g){g.preventDefault();c.startPlay("normal")},false);this.stopButton.addEventListener("click",function(g){g.preventDefault();c.midiPlayer.stopPlay()},false);this.midiPlayer.defineCallbackOnPlay(c.playerCallBackOnPlay);this.midiPlayer.defineCallbackOnEnd(c.playerCallBackOnEnd);this.midiPlayer.defineCallbackOnScroll(c.playerCallBackOnScroll);DR.addAgent(this);this.defineInstrument();this.showAccordionName();this.showAccordionImage();this.accordionSelector.populate(false);this.accordion.printKeyboard(this.keyboardDiv);this.loadOriginalRepertoire();this.resize()};SITE.Mapa.prototype.setup=function(a){if(this.accordion.accordionIsCurrent(a.accordionId)){return}this.midiPlayer.reset();this.accordion.loadById(a.accordionId);this.showAccordionName();this.showAccordionImage();this.accordionSelector.populate(false);this.accordion.printKeyboard(this.keyboardDiv);this.loadOriginalRepertoire();this.resize();if(!this.accordion.loaded.localResource){FILEMANAGER.saveLocal("property.accordion",this.accordion.getId())}};SITE.Mapa.prototype.resize=function(){var d=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;var b=document.getElementById("section1");var a=document.getElementById("section2");var c=(d-b.clientHeight-(a.clientHeight-this.tuneContainerDiv.clientHeight)-78-14-2);this.tuneContainerDiv.style.height=Math.max(c,200)+"px";this.posicionaMidia()};SITE.Mapa.prototype.menuCallback=function(a){switch(a){case"LOADMAP":this.fileLoadMap.click();break;case"SAVEMAP":this.save();break;case"RESTOREREPERTOIRE":this.restauraRepertorio();break;case"LOADREPERTOIRE":this.fileLoadRepertoire.click();break;case"EXPORTREPERTOIRE":this.exportaRepertorio();break;case"PART2TAB":this.openPart2Tab();break;case"TAB2PART":this.openTab2Part();break;case"JUMPS":this.showHelp("Ajuda - Símbolos de Repetição","/diatonic-map/html5/sinaisRepeticao.pt_BR.html",{width:"1024",height:"600"});break;case"ABCX":this.showHelp("Ajuda - Formato ABCX","/diatonic-map/html5/formatoABCX.pt_BR.html",{width:"1024",height:"600"});break;case"ESTUDIO":this.showHelp("Ajuda - Estúdio ABCX","/diatonic-map/html5/estudioABCX.pt_BR.html",{width:"1024",height:"600"});break;case"TABS":this.showHelp("Ajuda - Tablaturas para Acordeons","/diatonic-map/html5/tablatura.pt_BR.html",{width:"1024",height:"600"});break;case"TABSTRANSPORTADA":this.showHelp("Ajuda - Tablaturas para Transportada","/diatonic-map/html5/tablaturaTransportada.pt_BR.html",{width:"1024",height:"600"});break;case"MAPS":this.showHelp("Ajuda - Mapas para Acordeons","/diatonic-map/html5/mapas.pt_BR.html",{width:"1024",height:"600"});break;case"TUTORIAL":this.showHelp("Ajuda - Tutoriais","/diatonic-map/html5/tutoriais.pt_BR.html",{width:"1024",height:"600",print:false});break;case"ABOUT":this.showHelp("Sobre...","/diatonic-map/html5/about.pt_BR.html",{width:"800",print:false});break;case"GAITA_MINUANO_GC":case"GAITA_MINUANO_BC_TRANSPORTADA":case"GAITA_HOHNER_CLUB_IIIM_BR":default:this.setup({accordionId:a})}};SITE.Mapa.prototype.loadOriginalRepertoire=function(){if(this.accordion.loaded.localResource){return}var b=this;var a=this.startLoader("LoadRepertoire",this.tuneContainerDiv);a.start(function(){b.doLoadOriginalRepertoire(a)},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>")};SITE.Mapa.prototype.doLoadOriginalRepertoire=function(a){this.renderedChord.title=FILEMANAGER.loadLocal("property."+this.accordion.getId()+".chords.title")||this.accordion.loaded.getFirstChord();this.loadABCList(this.renderedChord.tab);this.renderedPractice.title=FILEMANAGER.loadLocal("property."+this.accordion.getId()+".practices.title")||this.accordion.loaded.getFirstPractice();this.loadABCList(this.renderedPractice.tab);this.renderedTune.title=FILEMANAGER.loadLocal("property."+this.accordion.getId()+".songs.title")||this.accordion.loaded.getFirstSong();
this.loadABCList(this.renderedTune.tab);this.showTab("songsTab");a.stop()};SITE.Mapa.prototype.printPartiture=function(b,c){var a=this.getActiveTab();c.preventDefault();b.blur();if(a.div.innerHTML){ga("send","event","Mapa5","print",a.title);this.printPreview(a.div.innerHTML,["#topBar","#mapaDiv"],a.abc.formatting.landscape)}};SITE.Mapa.prototype.openMapa=function(b){var a=this.getActiveTab();this.menu.enableSubMenu("menuGaitas");this.menu.enableSubMenu("menuRepertorio");this.setVisible(true);this.accordion.printKeyboard(this.keyboardDiv);this.resize();if(b!==undefined){if(b===a.text){return}else{a.text=b;this.accordion.loaded.setSong(a.title,a.text);this.renderTAB(a)}}};SITE.Mapa.prototype.closeMapa=function(){this.pauseMedia();this.midiPlayer.stopPlay();this.setVisible(false);this.menu.disableSubMenu("menuGaitas");this.menu.disableSubMenu("menuRepertorio")};SITE.Mapa.prototype.openPart2Tab=function(){if(!this.part2tab){this.part2tab=new SITE.TabGen(this,{tabGenDiv:"tabGenDiv",controlDiv:"p2tControlDiv-raw",saveBtn:"p2tSaveBtn",updateBtn:"p2tForceRefresh",openBtn:"p2tOpenInGenerator"})}this.part2tab.setup(this.activeTab.text)};SITE.Mapa.prototype.openTab2Part=function(){if(!this.tab2part){this.tab2part=new SITE.PartGen(this,{partGenDiv:"partGenDiv",controlDiv:"t2pControlDiv-raw",showMapBtn:"t2pShowMapBtn",showEditorBtn:"t2pShowEditorBtn",printBtn:"t2pPrintBtn",saveBtn:"t2pSaveBtn",updateBtn:"t2pForceRefresh",playBtn:"t2pPlayBtn",stopBtn:"t2pStopBtn",currentPlayTimeLabel:"t2pCurrentPlayTimeLabel",ckShowABC:"ckShowABC",ckConvertToClub:"ckConvertToClub",ckConvertFromClub:"ckConvertFromClub",generate_tablature:"accordion",accordion_options:{id:this.accordion.getId(),accordionMaps:DIATONIC.map.accordionMaps,render_keyboard_opts:{transpose:false,mirror:false,scale:0.8,draggable:true,show:false,label:false}}})}this.tab2part.setup({accordionId:this.accordion.getId()})};SITE.Mapa.prototype.openEstudio=function(c,e){var b=this;var d=b.getActiveTab();if(e){e.preventDefault();c.blur()}if(!this.studio){this.studio=new SITE.Estudio(this,{studioDiv:"studioDiv",studioControlDiv:"studioControlDiv",studioCanvasDiv:"studioCanvasDiv",generate_tablature:"accordion",showMapBtn:"showMapBtn",showEditorBtn:"showEditorBtn",showTextBtn:"showTextBtn",printBtn:"printBtn2",saveBtn:"saveBtn",forceRefresh:"forceRefresh",accordion_options:{id:this.accordion.getId(),accordionMaps:DIATONIC.map.accordionMaps,render_keyboard_opts:{transpose:false,mirror:false,scale:0.8,draggable:true,show:false,label:false}},onchange:function(f){f.onChange()}},{modeBtn:"modeBtn",timerBtn:"timerBtn",playBtn:"playBtn2",stopBtn:"stopBtn2",clearBtn:"clearBtn",gotoMeasureBtn:"gotoMeasureBtn",untilMeasureBtn:"untilMeasureBtn",stepBtn:"stepBtn",repeatBtn:"repeatBtn",stepMeasureBtn:"stepMeasureBtn",tempoBtn:"tempoBtn",GClefBtn:"GClefBtn",FClefBtn:"FClefBtn",currentPlayTimeLabel:"currentPlayTimeLabel2"})}if(d.text){ga("send","event","Mapa5","tools",d.title);var a=this.startLoader("OpenEstudio");a.start(function(){b.studio.setup(d,b.accordion.getId());a.stop()},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>")}};SITE.Mapa.prototype.startPlay=function(b,c){var a=this.getActiveTab();this.ypos=this.tuneContainerDiv.scrollTop;this.lastStaffGroup=-1;if(this.midiPlayer.playing){if(b==="normal"){this.playButton.title=DR.getResource("playBtn");this.playButton.innerHTML='<i class="ico-play"></i>';this.midiPlayer.pausePlay()}else{this.midiPlayer.pausePlay(true)}}else{this.accordion.clearKeyboard();if(b==="normal"){if(this.midiPlayer.startPlay(a.abc.midi)){ga("send","event","Mapa5","play",a.title);this.playButton.title=DR.getResource("DR_pause");this.playButton.innerHTML='<i class="ico-pause"></i>'}}else{if(this.midiPlayer.startDidacticPlay(a.abc.midi,b,c)){ga("send","event","Mapa5","didactic-play",a.title)}}}};SITE.Mapa.prototype.setScrolling=function(c){if(!this.tuneContainerDiv||c.currAbsElem.staffGroup===this.lastStaffGroup){return}this.lastStaffGroup=c.currAbsElem.staffGroup;var e=c.printer.staffgroups[0].top;var b=this.tuneContainerDiv.clientHeight-e;var d=c.printer.staffgroups[c.currAbsElem.staffGroup].top;var a=d+c.printer.staffgroups[c.currAbsElem.staffGroup].height;if(a>b+this.ypos||this.ypos>d-e){this.ypos=d;this.tuneContainerDiv.scrollTop=this.ypos}};SITE.Mapa.prototype.exportaRepertorio=function(){if(FILEMANAGER.requiredFeaturesAvailable()){var a=this.accordion.loaded;var b=a.getId().toLowerCase()+".repertorio.abcx";var c="";for(var d in a.songs.items){c+=a.songs.items[d]+"\n\n"}FILEMANAGER.download(b,c)}else{alert(DR.getResource("DR_err_saving"))}};SITE.Mapa.prototype.save=function(){var a=this.accordion.loaded;var b='{\n   "id":'+JSON.stringify(a.id)+'\n  ,"menuOrder":'+JSON.stringify(a.menuOrder+100)+'\n  ,"model":'+JSON.stringify(a.model)+'\n  ,"tuning":'+JSON.stringify(a.tuning)+'\n  ,"buttons":'+JSON.stringify(a.buttons)+'\n  ,"pedal":'+JSON.stringify(a.keyboard.pedalInfo)+'\n  ,"keyboard":\n  {\n     "layout":'+JSON.stringify(a.keyboard.layout)+'\n     ,"keys":\n     {\n        "close":'+JSON.stringify(a.keyboard.keys.close)+'\n       ,"open":'+JSON.stringify(a.keyboard.keys.open)+'\n     }\n     ,"basses":\n     {\n        "close":'+JSON.stringify(a.keyboard.basses.close)+'\n       ,"open":'+JSON.stringify(a.keyboard.basses.open)+"\n     }\n  }\n}\n";FILEMANAGER.download(a.getId().toLowerCase()+".accordion",b)};SITE.Mapa.prototype.loadMap=function(a){var b=this;a.preventDefault();FILEMANAGER.loadLocalFiles(a,function(){var c=b.startLoader("LoadRepertoire",b.tuneContainerDiv);c.start(function(){b.doLoadMap(FILEMANAGER.files,c)},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>");a.target.value=""})};SITE.Mapa.prototype.doLoadMap=function(b,k){var c,i;var e="",g="",j="";for(var h=0;h<b.length;h++){if(b[h].type==="image"){i=b[h].content}else{switch(b[h].extension.toLowerCase()){case"accordion":c=JSON.parse(b[h].content);break;case"abcx":case"tunes":e+=b[h].content;break;case"chords":g+=b[h].content;break;case"practices":j+=b[h].content;break}}}if(c===undefined){k.stop();console.log("O arquivo principal .accordion não foi encontrado!");return}c.image=i||"images/accordion.default.gif";if(!this.accordion.accordionExists(c.id)){DIATONIC.map.accordionMaps.push(new DIATONIC.map.AccordionMap(c,true));DIATONIC.map.sortAccordions()}this.setup({accordionId:c.id});var d=this.accordion.loaded;if(g){var a=new ABCXJS.TuneBook(g);for(var l=0;l<a.tunes.length;l++){d.chords.items[a.tunes[l].title]=a.tunes[l].abc;d.chords.sortedIndex.push(a.tunes[l].title)}d.chords.sortedIndex.sort();this.renderedChord.title=d.getFirstChord();this.loadABCList(this.renderedChord.tab)}if(j){var a=new ABCXJS.TuneBook(j);for(var l=0;l<a.tunes.length;l++){d.practices.items[a.tunes[l].title]=a.tunes[l].abc;d.practices.sortedIndex.push(a.tunes[l].title)}d.practices.sortedIndex.sort();this.renderedPractice.title=d.getFirstPractice();this.loadABCList(this.renderedPractice.tab)}if(e){var a=new ABCXJS.TuneBook(e);for(var l=0;l<a.tunes.length;
l++){d.songs.items[a.tunes[l].title]=a.tunes[l].abc;d.songs.sortedIndex.push(a.tunes[l].title)}d.songs.sortedIndex.sort();this.renderedTune.title=d.getFirstSong();this.loadABCList(this.renderedTune.tab)}this.showTab("songsTab");k.stop()};SITE.Mapa.prototype.restauraRepertorio=function(){var b=this;var a=b.accordion.loaded;if(a.localResource){return}a.songs=a.loadABCX(a.songPathList,function(){b.renderedTune.title=a.getFirstSong();b.loadABCList(b.renderedTune.tab);b.showTab("songsTab")})};SITE.Mapa.prototype.carregaRepertorioLocal=function(a){var b=this;FILEMANAGER.loadLocalFiles(a,function(){b.doCarregaRepertorioLocal(FILEMANAGER.files);a.target.value=""})};SITE.Mapa.prototype.doCarregaRepertorioLocal=function(d){var f=false;var a=this.accordion.loaded;for(var c=0;c<d.length;c++){var e=new ABCXJS.TuneBook(d[c].content);for(var b=0;b<e.tunes.length;b++){if(!a.songs.items[e.tunes[b].title]){a.songs.sortedIndex.push(e.tunes[b].title)}a.songs.items[e.tunes[b].title]=e.tunes[b].abc;if(!f){this.renderedTune.title=e.tunes[b].title;f=true}ga("send","event","Mapa5","load",e.tunes[b].title)}}a.songs.sortedIndex.sort();this.loadABCList(this.renderedTune.tab);this.showTab("songsTab")};SITE.Mapa.prototype.showTab=function(b){var a=this.getActiveTab();if(a){a.selector.style.display="none"}a=this.setActiveTab(b);a.selector.style.display="block";this.showMedia(a)};SITE.Mapa.prototype.showABC=function(h){var d=this;var c=h.split("-");var g=c[0];var e=parseInt(c[1]);var f=d.getActiveTab();var j=this.accordion.loaded[g].sortedIndex[e];if(f.title!==j&&f.menu.selectItem(f.ddmId,h)){f.title=j;f.text=this.accordion.loaded.getAbcText(f.tab,f.title);f.menu.setSubMenuTitle(f.ddmId,(f.title.length>43?f.title.substr(0,40)+"...":f.title));if(!this.accordion.loaded.localResource){FILEMANAGER.saveLocal("property."+this.accordion.getId()+"."+g+".title",f.title)}var b=this.startLoader("TABLoader"+g,this.tuneContainerDiv);b.start(function(){d.renderTAB(f);d.showMedia(f);d.tuneContainerDiv.scrollTop=0;b.stop()},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>")}else{console.log("Song title not found!")}};SITE.Mapa.prototype.loadABCList=function(e){var d,b;switch(e){case"songs":d=this.renderedTune;d.ddmId="songsMenu";b=this.accordion.loaded.songs.sortedIndex;break;case"practices":d=this.renderedPractice;d.ddmId="practicesMenu";b=this.accordion.loaded.practices.sortedIndex;break;case"chords":d=this.renderedChord;d.ddmId="chordsMenu";b=this.accordion.loaded.chords.sortedIndex;break}d.abc=d.text=undefined;d.div.innerHTML="";d.menu=new DRAGGABLE.ui.DropdownMenu(d.selector,{listener:this,method:"showABC"},[{title:"...",ddmId:d.ddmId,itens:[]}]);for(var c=0;c<b.length;c++){var f=b[c];var a=d.menu.addItemSubMenu(d.ddmId,f+"|"+e+"-"+c);if(f===d.title){d.menu.setSubMenuTitle(d.ddmId,f);d.menu.selectItem(d.ddmId,a);d.text=this.accordion.loaded.getAbcText(e,f)}}this.setActiveTab(e+"Tab");this.renderTAB(d)};SITE.Mapa.prototype.renderTAB=function(a){if(a.title===undefined||a.text===undefined){a.text=undefined;a.title=undefined;return}this.abcParser.parse(a.text,this.parserparams);a.abc=this.abcParser.getTune();a.text=this.abcParser.getStrTune();if(this.midiParser){this.midiParser.parse(a.abc,this.accordion.loadedKeyboard)}var b=new SVG.Printer(a.div);a.printer=new ABCXJS.write.Printer(b,this.printerparams);a.printer.printTune(a.abc);a.printer.addSelectListener(this);this.accordion.clearKeyboard(true)};SITE.Mapa.prototype.setActiveTab=function(a){document.getElementById(a).checked=true;if(this.activeTab){this.activeTab.selector.style.display="none"}switch(a){case"songsTab":this.activeTab=this.renderedTune;break;case"practicesTab":this.activeTab=this.renderedPractice;break;case"chordsTab":this.activeTab=this.renderedChord;break}return this.activeTab};SITE.Mapa.prototype.getActiveTab=function(){return this.activeTab};SITE.Mapa.prototype.setVisible=function(a){this.mapDiv.style.display=(a?"inline":"none")};SITE.Mapa.prototype.showAccordionImage=function(){this.gaitaImagePlaceHolder.innerHTML='<img src="'+this.accordion.loaded.image+'" alt="'+this.accordion.getFullName()+" "+DR.getResource("DR_keys")+'" style="height:200px; width:200px;" />'};SITE.Mapa.prototype.showAccordionName=function(){this.gaitaNamePlaceHolder.innerHTML=this.accordion.getFullName()+" "+DR.getResource("DR_keys")};SITE.Mapa.prototype.highlight=function(a){if(!this.midiPlayer.playing){this.accordion.clearKeyboard(true);this.midiParser.setSelection(a)}};SITE.Mapa.prototype.mediaCallback=function(b){switch(b){case"MOVE":var a=this.mediaWindow.topDiv;SITE.properties.mediaDiv.top=a.style.top;SITE.properties.mediaDiv.left=a.style.left;SITE.SaveProperties();break;case"OPEN":SITE.properties.mediaDiv.visible=true;SITE.SaveProperties();this.mediaWindow.setVisible(true);this.showMediaButton.style.display="none";break;case"CLOSE":this.pauseMedia();SITE.properties.mediaDiv.visible=false;SITE.SaveProperties();this.mediaWindow.setVisible(false);this.showMediaButton.style.display="inline";break}return false};SITE.Mapa.prototype.pauseMedia=function(){if(!this.mediaWindow){return}var a=this.mediaWindow.dataDiv.getElementsByTagName("iframe")[0];if(!a){return}a.contentWindow.postMessage('{"event":"command","func":"pauseVideo", "args":""}',"*")};SITE.Mapa.prototype.showMedia=function(c){var b;if(c.abc&&c.abc.metaText.url){b=c.abc.metaText.url}if(!this.mediaWindow){this.mediaWindow=new DRAGGABLE.ui.Window(this.mapDiv,null,{title:"Videoaula",translate:false,statusbar:false,top:SITE.properties.mediaDiv.top,left:SITE.properties.mediaDiv.left,zIndex:1000},{listener:this,method:"mediaCallback"})}if(b){if(window.innerWidth>1500){SITE.properties.mediaDiv.width=600;SITE.properties.mediaDiv.height=SITE.properties.mediaDiv.width*0.55666667}var a='<iframe width="'+SITE.properties.mediaDiv.width+'" height="'+SITE.properties.mediaDiv.height+'" src="'+b+'?rel=0&amp;showinfo=0&amp;enablejsapi=1" frameborder="0" allowfullscreen="allowfullscreen"></iframe>';this.mediaWindow.dataDiv.innerHTML=a;this.mediaWindow.dataDiv.style.width=SITE.properties.mediaDiv.width+"px";this.mediaWindow.dataDiv.style.height=SITE.properties.mediaDiv.height+"px";this.mediaWindow.dataDiv.style.overflow="hidden";this.showMediaButton.style.display=SITE.properties.mediaDiv.visible?"none":"inline";this.mediaWindow.setVisible(SITE.properties.mediaDiv.visible);if(SITE.properties.mediaDiv.visible){this.posicionaMidia()}else{this.pauseMedia()}}else{this.pauseMedia();this.mediaWindow.setVisible(false);this.showMediaButton.style.display="none"}};SITE.Mapa.prototype.posicionaMidia=function(){if(!SITE.properties.mediaDiv.visible||!this.mediaWindow||this.mediaWindow.topDiv.style.display==="none"){return}var b=window.innerWidth;var d=this.mediaWindow.topDiv;var a=parseInt(d.style.left.replace("px",""));var c=a;if(a+d.offsetWidth>b){a=(b-(d.offsetWidth+50))}if(a<0){a=10}if(a!==c){SITE.properties.mediaDiv.left=d.style.left=a+"px";SITE.SaveProperties()}};SITE.Mapa.prototype.startLoader=function(e,b,d,c){var a=new window.widgets.Loader({id:e,bars:0,radius:0,lineWidth:20,lineHeight:70,timeout:1,background:"rgba(0,0,0,0.5)",container:b?b:document.body,onstart:d,oncomplete:c});
return a};SITE.Mapa.prototype.defineInstrument=function(){var a=SITE.properties.options.pianoSound?0:21;MIDI.programChange(0,a);MIDI.programChange(1,a);MIDI.programChange(2,a);MIDI.programChange(3,a);MIDI.programChange(4,a);MIDI.programChange(5,a)};SITE.Mapa.prototype.showSettings=function(){var c=600;var b=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var a=b/2-c/2;if(!this.settings){this.settings={};this.settings.window=new DRAGGABLE.ui.Window(null,null,{title:"Preferências",translate:false,statusbar:false,top:"300px",left:a+"px",height:"400px",width:c+"px",zIndex:50},{listener:this,method:"settingsCallback"});this.settings.window.topDiv.style.zIndex=101;this.settings.window.dataDiv.innerHTML='        <div class="menu-group">            <table>              <tr>                <th colspan="2">Idioma:</th><th><div id="settingsLanguageMenu" class="topMenu"></div></th>              </tr>              <tr>                <th colspan="2"><br>Cores:</th><td></td>              </tr>              <tr>                <td style="width:15px;"></td><td>Cor de Realce</td><td><input id="corRealce" type="text" ><input id="chkTransparency" type="checkbox">&nbsp;Com transparência</td>              </tr>              <tr>                <td></td><td>Fole Fechando</td><td><input id="foleFechando" type="text" ></td>              </tr>              <tr>                <td></td><td>Fole Abrindo</td><td><input id="foleAbrindo" type="text" ></td>              </tr>              <tr>                <th colspan="2"><br>Propriedades:</th><td></td>              </tr>              <tr>                <td> </td><td colspan="2"><input id="chkPiano" type="checkbox">&nbsp;Usar sons de Piano Acústico</td>              </tr>              <tr>                <td> </td><td colspan="2"><input id="chkWarnings" type="checkbox">&nbsp;Mostrar avisos e erros de compilação</td>              </tr>              <tr>                <td> </td><td colspan="2"><input id="chkAutoRefresh" type="checkbox">&nbsp;Atualizar partitura automaticamente (experimental)</td>              </tr>            </table>        </div>        <div id="pg" class="pushbutton-group" style="right: 0; bottom: 0;" >            <div id="botao1"></div>\n            <div id="botao2"></div>\n            <div id="botao3"></div>\n        </div>';this.settings.window.addPushButtons(["botao1|APPLY|Aplicar","botao2|RESET|Redefinir","botao3|CANCEL|Cancelar"]);this.settings.menu=new DRAGGABLE.ui.DropdownMenu("settingsLanguageMenu",{listener:this,method:"settingsCallback"},[{title:"Idioma",ddmId:"menuIdiomas",itens:['<img src="images/pt_BR.png" alt="idiomas" />&#160;Português|pt_BR','<img src="images/en_US.png" alt="idiomas" />&#160;English|en_US','<img src="images/de_DE.png" alt="idiomas" />&#160;Deustch|de_DE']}]);this.picker=new DRAGGABLE.ui.ColorPicker(["corRealce","foleFechando","foleAbrindo"]);this.settings.menu.setSubMenuTitle("menuIdiomas",this.settings.menu.selectItem("menuIdiomas",SITE.properties.options.language));this.settings.menu.disableSubMenu("menuIdiomas");this.settings.useTransparency=document.getElementById("chkTransparency");this.settings.corRealce=document.getElementById("corRealce");this.settings.closeColor=document.getElementById("foleFechando");this.settings.openColor=document.getElementById("foleAbrindo");this.settings.showWarnings=document.getElementById("chkWarnings");this.settings.autoRefresh=document.getElementById("chkAutoRefresh");this.settings.pianoSound=document.getElementById("chkPiano")}this.settings.corRealce.style.backgroundColor=this.settings.corRealce.value=SITE.properties.colors.highLight;this.settings.closeColor.style.backgroundColor=this.settings.closeColor.value=SITE.properties.colors.close;this.settings.openColor.style.backgroundColor=this.settings.openColor.value=SITE.properties.colors.open;this.settings.showWarnings.checked=SITE.properties.options.showWarnings;this.settings.autoRefresh.checked=SITE.properties.options.autoRefresh;this.settings.pianoSound.checked=SITE.properties.options.pianoSound;this.settings.useTransparency.checked=SITE.properties.colors.useTransparency;this.settings.window.setVisible(true)};SITE.Mapa.prototype.settingsCallback=function(b,a){switch(b){case"MOVE":break;case"CLOSE":case"CANCEL":this.picker.close();this.settings.window.setVisible(false);break;case"APPLY":SITE.properties.colors.highLight=this.settings.corRealce.value;SITE.properties.colors.close=this.settings.closeColor.value;SITE.properties.colors.open=this.settings.openColor.value;SITE.properties.options.showWarnings=this.settings.showWarnings.checked;SITE.properties.options.autoRefresh=this.settings.autoRefresh.checked;SITE.properties.options.pianoSound=this.settings.pianoSound.checked;SITE.properties.colors.useTransparency=this.settings.useTransparency.checked;SITE.SaveProperties();this.picker.close();this.settings.window.setVisible(false);this.applySettings();break;case"RESET":this.alert=new DRAGGABLE.ui.Alert(this.settings.window,b,"<br>Você deseja redefinir todos os itens?","<br>Isto fará com que todos os itens retornem para suas configurações iniciais, isto inclui cores e posicionamento, entre outras coisas.");break;case"RESET-YES":this.alert.close();this.picker.close();this.settings.window.setVisible(false);SITE.ResetProperties();this.applySettings();break;case"RESET-NO":case"RESET-CANCEL":this.alert.close();break}};SITE.Mapa.prototype.applySettings=function(){this.defineInstrument();this.showMedia(this.getActiveTab());if(this.studio){this.studio.setAutoRefresh(SITE.properties.options.autoRefresh);this.studio.warningsDiv.style.display=SITE.properties.options.showWarnings?"block":"none"}if(this.tab2part){this.tab2part.warningsDiv.style.display=SITE.properties.options.showWarnings?"block":"none"}if(this.part2tab){this.part2tab.warningsDiv.style.display=SITE.properties.options.showWarnings?"block":"none"}this.resizeActiveWindow();ABCXJS.write.color.useTransparency=SITE.properties.colors.useTransparency;ABCXJS.write.color.highLight=SITE.properties.colors.highLight;DIATONIC.map.color.close=SITE.properties.colors.close;DIATONIC.map.color.open=SITE.properties.colors.open;this.accordion.loadedKeyboard.legenda.setOpen();this.accordion.loadedKeyboard.legenda.setClose()};SITE.Mapa.prototype.changePageOrientation=function(a){var b=document.createElement("style");document.head.appendChild(b);b.innerHTML="@page {margin: 1cm; size: "+a+"}"};SITE.Mapa.prototype.printPreview=function(b,c,d){var a=document.getElementById("printPreviewDiv");c.forEach(function(e){$(e).hide()});this.changePageOrientation(d?"landscape":"portrait");a.style.display="block";a.innerHTML=b;window.setTimeout(function(){window.print();a.style.display="none";c.forEach(function(e){$(e).show()})},100)};SITE.Mapa.prototype.resizeActiveWindow=function(){if(this.studio&&window.getComputedStyle(this.studio.Div.parent).display!=="none"){this.studio.resize()}else{if(this.tab2part&&window.getComputedStyle(this.tab2part.Div.parent).display!=="none"){this.tab2part.resize()
}else{if(this.part2tab&&window.getComputedStyle(this.part2tab.Div.parent).display!=="none"){this.part2tab.resize()}else{this.resize()}}}};SITE.Mapa.prototype.silencia=function(){if(this.studio&&window.getComputedStyle(this.studio.Div.parent).display!=="none"){if(this.studio.midiPlayer.playing){this.studio.startPlay("normal")}}else{if(this.tab2part&&window.getComputedStyle(this.tab2part.Div.parent).display!=="none"){if(this.tab2part.midiPlayer.playing){this.tab2part.startPlay("normal")}}else{if(this.midiPlayer.playing){this.startPlay("normal")}}}};SITE.Mapa.prototype.translate=function(){this.accordion.keyboard.legenda.setText(true,DR.getResource("DR_pull"),DR.getResource("DR_push"));this.showAccordionName();document.title=DR.getResource("DR_title");DR.setDescription();document.getElementById("toolsBtn").innerHTML='<i class="ico-wrench"></i>&#160;'+DR.getResource("toolsBtn");document.getElementById("printBtn2").innerHTML='<i class="ico-print"></i>&#160;'+DR.getResource("printBtn");document.getElementById("pdfBtn").innerHTML='<i class="ico-print"></i>&#160;'+DR.getResource("pdfBtn");document.getElementById("DR_message").alt=DR.getResource("DR_message");document.getElementById("octaveUpBtn").title=DR.getResource("DR_octave");document.getElementById("octaveUpBtn").innerHTML='<i class="ico-octave-up"></i>&#160;'+DR.getResource("DR_octave");document.getElementById("octaveDwBtn").title=DR.getResource("DR_octave");document.getElementById("octaveDwBtn").innerHTML='<i class="ico--octave-down"></i>&#160;'+DR.getResource("DR_octave");document.getElementById("printBtn").innerHTML='<i class="ico-print"></i>&#160;'+DR.getResource("printBtn");document.getElementById("saveBtn").innerHTML='<i class="ico-download"></i>&#160;'+DR.getResource("saveBtn");document.getElementById("forceRefresh").innerHTML=DR.getResource("forceRefresh");document.getElementById("forceRefresh2").innerHTML=DR.getResource("forceRefresh");document.getElementById("gotoMeasureBtn").value=DR.getResource("DR_goto");document.getElementById("untilMeasureBtn").value=DR.getResource("DR_until")};SITE.Mapa.prototype.showHelp=function(g,d,c){var f=this;c=c||{};c.width=typeof c.width==="undefined"?"800":c.width;c.height=typeof c.height==="undefined"?undefined:c.height;c.print=typeof c.print==="undefined"?true:c.print;var e=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var b=e/2-c.width/2;if(!this.helpWindow){this.helpWindow=new DRAGGABLE.ui.Window(null,["PRINT|Imprimir"],{title:"",translate:false,draggable:true,statusbar:false,top:"200px",left:b+"px",height:"auto",zIndex:70},{listener:this,method:"helpCallback"});this.helpWindow.dataDiv.style.height="auto";this.helpWindow.dataDiv.className+=" customScrollBar"}this.helpWindow.setTitle(g);this.helpWindow.setButtonVisible("PRINT",c.print);this.helpWindow.dataDiv.innerHTML='<object data="'+d+'" type="text/html" ></object>';this.iframe=this.helpWindow.dataDiv.getElementsByTagName("object")[0];var a=this.startLoader("About");this.iframe.style.width=c.width+"px";this.iframe.style.height=(c.height?c.height:400)+"px";f.helpWindow.topDiv.style.opacity="0";f.helpWindow.setVisible(true);a.start(function(){if(c.height){f.iframe.addEventListener("load",function(){f.helpWindow.topDiv.style.opacity="1";f.iframe.style.height=c.height+"px";a.stop();this.contentDocument.body.className+="customScrollBar";var i=this.contentDocument.getElementById("helpHeader");var h=this.contentDocument.getElementById("helpContainer");if(i){i.style.display="none"}if(h){h.style.top="0";h.style.border="1px solid rgba(255, 153, 34, 0.2)"}})}else{f.iframe.addEventListener("load",function(){this.contentDocument.body.style.overflow="hidden";var h=this.contentDocument.getElementById("siteVerI");if(h){h.innerHTML=SITE.siteVersion}f.iframe.style.height=this.contentDocument.body.clientHeight+"px";f.helpWindow.topDiv.style.opacity="1";a.stop()})}},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>")};SITE.Mapa.prototype.helpCallback=function(b){if(b==="CLOSE"){this.helpWindow.setVisible(false)}else{if(b==="PRINT"){var a=this.iframe.contentDocument.getElementById("helpContainer");if(a){this.printPreview(a.innerHTML,["#topBar","#mapaDiv"],false)}}}};SITE.Mapa.prototype.debugRepertorio=function(){var d=[];for(var e in this.accordion.loaded.songs.items){d.push(e);var b=d.length;this.abcParser.parse(this.accordion.loaded.songs.items[e]);var a=this.abcParser.getWarnings()||[];for(var c=0;c<a.length;c++){d.push("\n\t"+a[c])}if(this.midiParser){this.midiParser.parse(this.abcParser.getTune(),this.accordion.loadedKeyboard);var a=this.midiParser.getWarnings();for(var c=0;c<a.length;c++){d.push("\n\t"+a[c])}}d.push(b===d.length?" --> OK\n":"\n")}console.log(d.join(""))};if(!window.SITE){window.SITE={}}SITE.Estudio=function(b,f,e){this.mapa=b;this.ypos=0;this.lastStaffGroup=-1;this.lastYpos=0;var c=this;var a="canvasDiv";var d="warningsDiv";this.warnings=[];this.renderedTune={text:undefined,abc:undefined,title:undefined,tab:undefined,div:undefined,selector:undefined};this.Div=new DRAGGABLE.ui.Window(f.studioDiv,null,{translate:false,statusbar:false,draggable:false,top:"3px",left:"1px",width:"100%",height:"100%",title:"Estúdio ABCX"},{listener:this,method:"studioCallback"});this.Div.setVisible(true);this.Div.dataDiv.style.overflow="hidden";if(f.generate_tablature){if(f.generate_tablature==="accordion"){this.accordion=new ABCXJS.tablature.Accordion(f.accordion_options);if(f.accordionNameSpan){this.accordionNameSpan=document.getElementById(f.accordionNameSpan);this.accordionNameSpan.innerHTML=this.accordion.getFullName()}}else{throw new Error("Tablatura para "+f.generate_tablature+" não suportada!")}}this.editorWindow=new ABCXJS.edit.EditArea(this.Div.dataDiv,{listener:this,method:"editorCallback"},{draggable:SITE.properties.studio.editor.floating,toolbar:true,statusbar:true,translate:false,title:"Editor ABCX",compileOnChange:SITE.properties.options.autoRefresh});this.editorWindow.setVisible(false);this.keyboardWindow=new DRAGGABLE.ui.Window(this.Div.dataDiv,["move|Mover","rotate|Rotacionar","zoom|Zoom","globe|Mudar Notação"],{title:"",translate:false,statusbar:false,top:SITE.properties.studio.keyboard.top,left:SITE.properties.studio.keyboard.left,zIndex:100},{listener:this,method:"keyboardCallback"});this.accordion.setRenderOptions({draggable:true,show:SITE.properties.studio.keyboard.visible,transpose:SITE.properties.studio.keyboard.transpose,mirror:SITE.properties.studio.keyboard.mirror,scale:SITE.properties.studio.keyboard.scale,label:SITE.properties.studio.keyboard.label});this.controlDiv=document.createElement("DIV");this.controlDiv.setAttribute("id","controlDiv");this.controlDiv.setAttribute("class","controlDiv btn-group");this.Div.dataDiv.appendChild(this.controlDiv);this.controlDiv.innerHTML=document.getElementById(f.studioControlDiv).innerHTML;document.getElementById(f.studioControlDiv).innerHTML="";this.warningsDiv=document.createElement("DIV");this.warningsDiv.setAttribute("id",d);
this.warningsDiv.setAttribute("class","warningsDiv");this.Div.dataDiv.appendChild(this.warningsDiv);this.studioCanvasDiv=document.createElement("DIV");this.studioCanvasDiv.setAttribute("id",f.studioCanvasDiv);this.studioCanvasDiv.setAttribute("class","studioCanvasDiv customScrollBar");this.canvasDiv=document.createElement("DIV");this.canvasDiv.setAttribute("id",a);this.canvasDiv.setAttribute("class","canvasDiv");this.studioCanvasDiv.appendChild(this.canvasDiv);this.renderedTune.div=this.canvasDiv;this.Div.dataDiv.appendChild(this.studioCanvasDiv);if(f.onchange){this.onchangeCallback=f.onchange}this.saveButton=document.getElementById(f.saveBtn);this.forceRefreshButton=document.getElementById(f.forceRefresh);this.printButton=document.getElementById(f.printBtn);this.showMapButton=document.getElementById(f.showMapBtn);this.showEditorButton=document.getElementById(f.showEditorBtn);this.modeButton=document.getElementById(e.modeBtn);this.timerButton=document.getElementById(e.timerBtn);this.FClefButton=document.getElementById(e.FClefBtn);this.GClefButton=document.getElementById(e.GClefBtn);this.playButton=document.getElementById(e.playBtn);this.stopButton=document.getElementById(e.stopBtn);this.gotoMeasureButton=document.getElementById(e.gotoMeasureBtn);this.untilMeasureButton=document.getElementById(e.untilMeasureBtn);this.currentPlayTimeLabel=document.getElementById(e.currentPlayTimeLabel);this.stepButton=document.getElementById(e.stepBtn);this.stepMeasureButton=document.getElementById(e.stepMeasureBtn);this.repeatButton=document.getElementById(e.repeatBtn);this.clearButton=document.getElementById(e.clearBtn);this.tempoButton=document.getElementById(e.tempoBtn);this.showEditorButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.showEditor()},false);this.showMapButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.showKeyboard()},false);this.forceRefreshButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.fireChanged(0,{force:true,showProgress:true})},false);this.saveButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.salvaMusica()},false);this.printButton.addEventListener("click",function(g){g.preventDefault();this.blur();ga("send","event","Mapa5","print",c.renderedTune.title);c.mapa.printPreview(c.renderedTune.div.innerHTML,["#topBar","#studioDiv"],c.renderedTune.abc.formatting.landscape);return},false);this.modeButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.changePlayMode()},false);this.timerButton.addEventListener("click",function(g){g.preventDefault();this.blur();SITE.properties.studio.timerOn=!SITE.properties.studio.timerOn;c.setTimerIcon(0)},false);this.FClefButton.addEventListener("click",function(g){g.preventDefault();this.blur();SITE.properties.studio.bassOn=!SITE.properties.studio.bassOn;c.setBassIcon()},false);this.GClefButton.addEventListener("click",function(g){g.preventDefault();this.blur();SITE.properties.studio.trebleOn=!SITE.properties.studio.trebleOn;c.setTrebleIcon()},false);this.playButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.startPlay("normal")},false);this.stopButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.midiPlayer.stopPlay();c.editorWindow.setReadOnly(false);c.editorWindow.clearEditorHighLightStyle()},false);this.clearButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.renderedTune.printer.clearSelection();c.accordion.clearKeyboard(true);c.currentPlayTimeLabel.innerHTML="00:00.00";c.editorWindow.setReadOnly(false);c.editorWindow.clearEditorHighLightStyle();c.midiPlayer.stopPlay()},false);this.stepButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.startPlay("note")},false);this.stepMeasureButton.addEventListener("click",function(g){g.preventDefault();c.startPlay("measure")},false);this.repeatButton.addEventListener("click",function(g){g.preventDefault();this.blur();c.startPlay("repeat",c.gotoMeasureButton.value,c.untilMeasureButton.value)},false);this.tempoButton.addEventListener("click",function(h){h.preventDefault();this.blur();var g=c.midiPlayer.adjustAndamento();switch(g){case 1:c.tempoButton.innerHTML="&#160;&#160;1&#160;&#160";break;case 1/2:c.tempoButton.innerHTML="&#160;&#189;&#160;";break;case 1/4:c.tempoButton.innerHTML="&#160;&#188;&#160;";break}},false);this.gotoMeasureButton.addEventListener("keypress",function(g){if(g.keyCode===13){c.startPlay("goto",this.value,c.untilMeasureButton.value)}},false);this.gotoMeasureButton.addEventListener("focus",function(g){if(this.value===DR.getResource("DR_goto")){this.value=""}},false);this.gotoMeasureButton.addEventListener("blur",function(g){if(this.value===""){this.value=DR.getResource("DR_goto")}},false);this.untilMeasureButton.addEventListener("keypress",function(g){if(g.keyCode===13){c.startPlay("goto",c.gotoMeasureButton.value,this.value)}},false);this.untilMeasureButton.addEventListener("focus",function(g){if(this.value===DR.getResource("DR_until")){this.value=""}},false);this.untilMeasureButton.addEventListener("blur",function(g){if(this.value===""){this.value=DR.getResource("DR_until")}},false);this.playerCallBackOnScroll=function(g){c.setScrolling(g)};this.playerCallBackOnPlay=function(g){var h=g.getTime().cTime;if(c.gotoMeasureButton&&!parseInt(c.untilMeasureButton.value)){c.gotoMeasureButton.value=g.currentMeasure}if(c.currentPlayTimeLabel){c.currentPlayTimeLabel.innerHTML=h}c.midiPlayer.setPlayableClefs((SITE.properties.studio.trebleOn?"T":"")+(SITE.properties.studio.bassOn?"B":""))};this.playerCallBackOnEnd=function(h){var j=c.midiPlayer.getWarnings();c.playButton.title=DR.getResource("playBtn");c.playButton.innerHTML='&#160;<i class="ico-play"></i>&#160;';c.renderedTune.printer.clearSelection();c.accordion.clearKeyboard(true);if(c.currentPlayTimeLabel){c.currentPlayTimeLabel.innerHTML="00:00.00"}if(j){var i=document.getElementById("warningsDiv");var g="";j.forEach(function(k){g+=k+"<br/>"});i.style.color="blue";i.innerHTML=g}};this.midiParser=new ABCXJS.midi.Parse();this.midiPlayer=new ABCXJS.midi.Player(this);this.midiPlayer.defineCallbackOnPlay(this.playerCallBackOnPlay);this.midiPlayer.defineCallbackOnEnd(this.playerCallBackOnEnd);this.midiPlayer.defineCallbackOnScroll(this.playerCallBackOnScroll);DR.addAgent(this)};SITE.Estudio.prototype.setup=function(b,a){this.mapa.closeMapa();this.accordion.loadById(a);this.renderedTune.abc=b.abc;this.renderedTune.text=b.text;this.renderedTune.title=b.title;this.studioCanvasDiv.scrollTop=0;this.changePlayMode(SITE.properties.studio.mode);this.setBassIcon();this.setTrebleIcon();this.setTimerIcon(0);this.setVisible(true);this.setString(b.text);this.fireChanged(0,{force:true});this.Div.setTitle("-&#160;"+this.accordion.getTxtModel());this.warningsDiv.style.display=SITE.properties.options.showWarnings?"block":"none";this.showEditor(SITE.properties.studio.editor.visible);this.editorWindow.container.setTitle("-&#160;"+b.title);
this.editorWindow.restartUndoManager();if(SITE.properties.studio.editor.floating){if(SITE.properties.studio.editor.maximized){this.editorWindow.setFloating(true);this.editorWindow.container.dispatchAction("MAXIMIZE")}else{this.editorWindow.container.dispatchAction("POPOUT")}}else{this.editorWindow.container.dispatchAction("POPIN")}this.showKeyboard(SITE.properties.studio.keyboard.visible);this.keyboardWindow.setTitle(this.accordion.getTxtTuning()+" - "+this.accordion.getTxtNumButtons())};SITE.Estudio.prototype.resize=function(){var i=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;var d=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var f=(i-78-10);var a=(d-8);this.Div.topDiv.style.height=Math.max(f,200)+"px";this.Div.topDiv.style.width=Math.max(a,400)+"px";var a=0,g=0;var j=this.controlDiv.clientHeight;var b=this.Div.dataDiv.clientHeight;if(!SITE.properties.showWarnings){a=this.warningsDiv.clientHeight}if(!SITE.properties.studio.editor.floating){g=this.editorWindow.container.topDiv.clientHeight+4}this.studioCanvasDiv.style.height=b-(a+g+j+6)+"px";this.posicionaTeclado()};SITE.Estudio.prototype.showKeyboard=function(a){SITE.properties.studio.keyboard.visible=(typeof a==="undefined"?!SITE.properties.studio.keyboard.visible:a);this.accordion.render_opts.show=SITE.properties.studio.keyboard.visible;if(SITE.properties.studio.keyboard.visible){this.keyboardWindow.setVisible(true);this.accordion.printKeyboard(this.keyboardWindow.dataDiv);document.getElementById("I_showMap").setAttribute("class","ico-folder-open");this.posicionaTeclado()}else{this.accordion.render_opts.show=false;this.keyboardWindow.setVisible(false);document.getElementById("I_showMap").setAttribute("class","ico-folder")}};SITE.Estudio.prototype.showEditor=function(a){SITE.properties.studio.editor.visible=(typeof a==="undefined"?!SITE.properties.studio.editor.visible:a);if(SITE.properties.studio.editor.visible){this.editorWindow.setVisible(true);this.editorWindow.resize();document.getElementById("I_showEditor").setAttribute("class","ico-folder-open")}else{document.getElementById("I_showEditor").setAttribute("class","ico-folder");this.editorWindow.setVisible(false)}this.resize()};SITE.Estudio.prototype.editorCallback=function(b,a){switch(b){case"0":break;case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"10":case"11":case"-1":case"-2":case"-3":case"-4":case"-5":case"-6":case"-7":case"-8":case"-9":case"-10":case"-11":this.fireChanged(parseInt(b),{force:true});break;case"OCTAVEUP":this.fireChanged(12,{force:true});break;case"OCTAVEDOWN":this.fireChanged(-12,{force:true});break;case"REFRESH":this.fireChanged(0,{force:true});break;case"DOWNLOAD":this.salvaMusica();break;case"MAXIMIZE":this.editorWindow.maximizeWindow(true,SITE.properties.studio.editor);break;case"RESTORE":this.editorWindow.maximizeWindow(false,SITE.properties.studio.editor);break;case"POPIN":this.editorWindow.dockWindow(true,SITE.properties.studio.editor,0,0,"calc(100% - 5px)","200px");this.resize();break;case"POPOUT":this.editorWindow.dockWindow(false,SITE.properties.studio.editor);this.resize();break;case"RESIZE":case"MOVE":this.editorWindow.retrieveProps(SITE.properties.studio.editor);break;case"CLOSE":this.showEditor(false);break}};SITE.Estudio.prototype.studioCallback=function(a){switch(a){case"CLOSE":this.closeEstudio(true);break}};SITE.Estudio.prototype.closeEstudio=function(c){var a=this.mapa.startLoader("CloseStudio");var b=this;a.start(function(){(c)&&SITE.SaveProperties();b.setVisible(false);b.midiPlayer.stopPlay();b.mapa.openMapa(b.getString());a.stop()},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>")};SITE.Estudio.prototype.setVisible=function(a){this.Div.parent.style.display=a?"block":"none"};SITE.Estudio.prototype.setAutoRefresh=function(a){this.editorWindow.setCompileOnChange(a)};SITE.Estudio.prototype.getString=function(){return this.editorWindow.getString()};SITE.Estudio.prototype.setString=function(a){this.editorWindow.setString(a)};SITE.Estudio.prototype.keyboardCallback=function(b){switch(b){case"MOVE":var a=this.keyboardWindow.topDiv.style;SITE.properties.studio.keyboard.left=a.left;SITE.properties.studio.keyboard.top=a.top;break;case"ROTATE":this.accordion.rotateKeyboard(this.keyboardWindow.dataDiv);SITE.properties.studio.keyboard.transpose=this.accordion.render_opts.transpose;SITE.properties.studio.keyboard.mirror=this.accordion.render_opts.mirror;break;case"ZOOM":this.accordion.scaleKeyboard(this.keyboardWindow.dataDiv);SITE.properties.studio.keyboard.scale=this.accordion.render_opts.scale;break;case"GLOBE":this.accordion.changeNotation();SITE.properties.studio.keyboard.label=this.accordion.render_opts.label;break;case"CLOSE":this.showKeyboard(false);break}};SITE.Estudio.prototype.setScrolling=function(c){if(!this.studioCanvasDiv||c.currAbsElem.staffGroup===this.lastStaffGroup){return}this.lastStaffGroup=c.currAbsElem.staffGroup;var e=c.printer.staffgroups[0].top;var b=this.studioCanvasDiv.clientHeight-e;var d=c.printer.staffgroups[c.currAbsElem.staffGroup].top;var a=d+c.printer.staffgroups[c.currAbsElem.staffGroup].height;if(a>b+this.ypos||this.ypos>d-e){this.ypos=d;this.studioCanvasDiv.scrollTop=this.ypos}};SITE.Estudio.prototype.salvaMusica=function(){if(FILEMANAGER.requiredFeaturesAvailable()){this.parseABC(0,true);var a=this.renderedTune.abc.metaText.title+".abcx";var b=this.getString();FILEMANAGER.download(a,b)}else{alert(DR.getResource("DR_err_saving"))}};SITE.Estudio.prototype.changePlayMode=function(a){SITE.properties.studio.mode=a?a:(SITE.properties.studio.mode==="normal"?"learning":"normal");if(SITE.properties.studio.mode==="normal"){$("#divDidacticPlayControls").hide();SITE.properties.studio.mode="normal";this.modeButton.innerHTML='<i class="ico-listening" ></i>';this.midiPlayer.resetAndamento(SITE.properties.studio.mode);$("#divNormalPlayControls").fadeIn()}else{$("#divNormalPlayControls").hide();SITE.properties.studio.mode="learning";this.modeButton.innerHTML='<i class="ico-learning" ></i>';this.midiPlayer.resetAndamento(SITE.properties.studio.mode);$("#divDidacticPlayControls").fadeIn()}};SITE.Estudio.prototype.posicionaTeclado=function(){if(!SITE.properties.studio.keyboard.visible){return}var b=window.innerWidth;var c=this.keyboardWindow.topDiv;var a=parseInt(c.style.left.replace("px",""));if(a+c.offsetWidth>b){a=(b-(c.offsetWidth+50))}if(a<0){a=10}c.style.left=a+"px"};SITE.Estudio.prototype.startPlay=function(b,c,a){this.ypos=this.studioCanvasDiv.scrollTop;this.lastStaffGroup=-1;if(this.midiPlayer.playing){if(b==="normal"){this.playButton.title=DR.getResource("playBtn");this.playButton.innerHTML='&#160;<i class="ico-play"></i>&#160;';this.midiPlayer.pausePlay()}else{this.midiPlayer.pausePlay(true)}this.editorWindow.setReadOnly(false);this.editorWindow.clearEditorHighLightStyle()}else{this.accordion.clearKeyboard();this.editorWindow.setReadOnly(true);this.editorWindow.setEditorHighLightStyle();
this.StartPlayWithTimer(this.renderedTune.abc.midi,b,c,a,SITE.properties.studio.timerOn?10:0)}};SITE.Estudio.prototype.setBassIcon=function(){if(SITE.properties.studio.bassOn){this.FClefButton.innerHTML='<i class="ico-clef-bass" ></i>'}else{this.FClefButton.innerHTML='<i class="ico-clef-bass" style="opacity:0.5;"></i><i class="ico-forbidden" style="position:absolute;left:4px;top:3px"></i>'}};SITE.Estudio.prototype.setTrebleIcon=function(){if(SITE.properties.studio.trebleOn){this.GClefButton.innerHTML='<i class="ico-clef-treble" ></i>'}else{this.GClefButton.innerHTML='<i class="ico-clef-treble" style="opacity:0.5;"></i><i class="ico-forbidden" style="position:absolute;left:4px;top:3px"></i>'}};SITE.Estudio.prototype.setTimerIcon=function(b){b=b||0;var a="00";if(SITE.properties.studio.timerOn){switch(b){case 0:a="00";break;case 1:a="05";break;case 2:a="15";break;case 3:a="20";break;case 6:a="30";break;case 9:a="45";break;default:a=""}if(a!==""){if(a!=="00"){MIDI.noteOn(0,90,100,0);MIDI.noteOff(0,90,b>3?0.1:0.05)}this.timerButton.innerHTML='<i class="ico-timer-'+a+'" ></i>'}}else{this.timerButton.innerHTML='<i class="ico-timer-00" style="opacity:0.5;"></i><i class="ico-forbidden" style="position:absolute;left:4px;top:4px"></i>'}};SITE.Estudio.prototype.StartPlayWithTimer=function(f,c,e,b,a){var d=this;if(c!=="note"&&SITE.properties.studio.timerOn&&a>0){d.setTimerIcon(a);a-=1;window.setTimeout(function(){d.StartPlayWithTimer(f,c,e,b,a)},1000/3)}else{d.setTimerIcon(0);if(c==="normal"){this.midiPlayer.setPlayableClefs("TB");if(this.midiPlayer.startPlay(this.renderedTune.abc.midi)){ga("send","event","Mapa5","play",this.renderedTune.title);this.playButton.title=DR.getResource("DR_pause");this.playButton.innerHTML='&#160;<i class="ico-pause"></i>&#160;'}}else{this.midiPlayer.setPlayableClefs((SITE.properties.studio.trebleOn?"T":"")+(SITE.properties.studio.bassOn?"B":""));ga("send","event","Mapa5","didactic-play",this.renderedTune.title);this.midiPlayer.startDidacticPlay(this.renderedTune.abc.midi,c,e,b)}}};SITE.Estudio.prototype.parseABC=function(c,d){var e=this.getString();this.warnings=[];if(e===""){this.renderedTune.text=this.initialText=this.renderedTune.abc=undefined;return true}if(e===this.initialText&&!d){this.updateSelection();return false}if(typeof c!=="undefined"){if(this.transposer){this.transposer.reset(c)}else{this.transposer=new ABCXJS.parse.Transposer(c)}}if(!this.abcParser){this.abcParser=new ABCXJS.parse.Parse(this.transposer,this.accordion)}this.abcParser.parse(e,this.parserparams);this.renderedTune.abc=this.abcParser.getTune();this.renderedTune.text=this.initialText=this.abcParser.getStrTune();if(e!==this.initialText){this.setString(this.renderedTune.text)}if(this.transposer&&this.editorWindow.keySelector){this.editorWindow.keySelector.populate(this.transposer.keyToNumber(this.transposer.getKeyVoice(0)))}var b=this.abcParser.getWarnings()||[];for(var a=0;a<b.length;a++){this.warnings.push(b[a])}if(this.midiParser){this.midiParser.parse(this.renderedTune.abc,this.accordion.loadedKeyboard);var b=this.midiParser.getWarnings();for(var a=0;a<b.length;a++){this.warnings.push(b[a])}}return true};SITE.Estudio.prototype.onChange=function(){this.studioCanvasDiv.scrollTop=this.lastYpos;this.resize()};SITE.Estudio.prototype.fireChanged=function(b,a){if(this.changing){return}this.changing=true;var c=a||{};var d=c.force||false;var e=c.showProgress||false;if(this.parseABC(b,d)){this.modelChanged(e)}else{delete this.changing}};SITE.Estudio.prototype.modelChanged=function(c){var b=this;if(c){var a=this.mapa.startLoader("ModelChanged");a.start(function(){b.onModelChanged(a)},"<br>&nbsp;&nbsp;&nbsp;Gerando partitura...<br><br>")}else{b.onModelChanged()}};SITE.Estudio.prototype.onModelChanged=function(a){this.renderedTune.div.innerHTML="";this.renderedTune.div.style.display="none";if(this.renderedTune.abc===undefined){delete this.changing;return}this.renderedTune.div.style.display="";var b=new SVG.Printer(this.renderedTune.div);this.renderedTune.printer=new ABCXJS.write.Printer(b,this.printerparams);this.renderedTune.printer.printTune(this.renderedTune.abc);if(this.warningsDiv){this.warningsDiv.style.color=this.warnings.length>0?"red":"green";this.warningsDiv.innerHTML=(this.warnings.length>0?this.warnings.join("<br/>"):"No warnings or errors.")}this.renderedTune.printer.addSelectListener(this);this.updateSelection();if(this.onchangeCallback){this.onchangeCallback(this)}if(a){a.update(false,"<br>&nbsp;&nbsp;&nbsp;Gerando tablatura...<br><br>");a.stop()}delete this.changing};SITE.Estudio.prototype.highlight=function(a){if(SITE.properties.studio.editor.visible){this.editorWindow.setSelection(a)}if(SITE.properties.studio.keyboard.visible&&!this.midiPlayer.playing){this.accordion.clearKeyboard(true);this.midiParser.setSelection(a)}};SITE.Estudio.prototype.unhighlight=function(a){if(SITE.properties.studio.editor.visible){this.editorWindow.clearSelection(a)}};SITE.Estudio.prototype.updateSelection=function(c){var b=this;if(c){var a=b.editorWindow.getSelection();try{b.renderedTune.printer.rangeHighlight(a)}catch(d){}delete this.updating}else{if(this.updating){return}this.updating=true;setTimeout(b.updateSelection(true),300)}};SITE.Estudio.prototype.translate=function(){};if(!window.SITE){window.SITE={}}SITE.PartGen=function(c,g){this.mapa=c;var d=this;this.Div=new DRAGGABLE.ui.Window(g.partGenDiv,["help|Ajuda"],{translate:false,statusbar:false,draggable:false,top:"3px",left:"1px",width:"100%",height:"100%",title:"Gerador de Partituras"},{listener:this,method:"t2pCallback"});this.Div.setVisible(true);this.Div.dataDiv.style.overflow="hidden";this.midiParser=new ABCXJS.midi.Parse();this.midiPlayer=new ABCXJS.midi.Player(this);var f=(g.accordion_options.id==="GAITA_HOHNER_CLUB_IIIM_BR");var a=(g.accordion_options.id!=="GAITA_HOHNER_CLUB_IIIM_BR");var b="t2pCanvasDiv";var e="t2pWarningsDiv";this.renderedTune={text:undefined,abc:undefined,title:undefined,tab:undefined,div:undefined,selector:undefined};this.tabParser=new ABCXJS.Tab2Part(f,a);if(g.generate_tablature){if(g.generate_tablature==="accordion"){this.accordion=new ABCXJS.tablature.Accordion(g.accordion_options);if(g.accordionNameSpan){this.accordionNameSpan=document.getElementById(g.accordionNameSpan);this.accordionNameSpan.innerHTML=this.accordion.getFullName()}}else{throw new Error("Tablatura para "+g.generate_tablature+" não suportada!")}}this.editorWindow=new ABCXJS.edit.EditArea(this.Div.dataDiv,{listener:this,method:"editorCallback"},{draggable:SITE.properties.partGen.editor.floating,toolbar:true,statusbar:true,translate:false,title:"Editor de Tablaturas",compileOnChange:false});this.editorWindow.setVisible(false);this.editorWindow.container.setButtonVisible("OCTAVEUP",false);this.editorWindow.container.setButtonVisible("OCTAVEDOWN",false);this.editorWindow.keySelector.setVisible(false);this.keyboardWindow=new DRAGGABLE.ui.Window(this.Div.dataDiv,["move|Mover","rotate|Rotacionar","zoom|Zoom","globe|Mudar Notação"],{title:"",translate:false,statusbar:false,top:SITE.properties.partGen.keyboard.top,left:SITE.properties.partGen.keyboard.left,zIndex:100},{listener:this,method:"keyboardCallback"});
this.accordion.setRenderOptions({draggable:true,show:SITE.properties.partGen.keyboard.visible,transpose:SITE.properties.partGen.keyboard.transpose,mirror:SITE.properties.partGen.keyboard.mirror,scale:SITE.properties.partGen.keyboard.scale,label:SITE.properties.partGen.keyboard.label});this.controlDiv=document.createElement("DIV");this.controlDiv.setAttribute("id","t2pcontrolDiv");this.controlDiv.setAttribute("class","controlDiv btn-group");this.Div.dataDiv.appendChild(this.controlDiv);this.controlDiv.innerHTML=document.getElementById(g.controlDiv).innerHTML;document.getElementById(g.controlDiv).innerHTML="";this.warningsDiv=document.createElement("DIV");this.warningsDiv.setAttribute("id",e);this.warningsDiv.setAttribute("class","warningsDiv");this.Div.dataDiv.appendChild(this.warningsDiv);this.abcDiv=document.createElement("DIV");this.abcDiv.style.display=SITE.properties.partGen.showABCText?"":"none";this.ckShowABC=document.getElementById(g.ckShowABC);this.ckShowABC.checked=SITE.properties.partGen.showABCText;this.ckConvertToClub=document.getElementById(g.ckConvertToClub);this.convertToClub=document.getElementById("convertToClub");this.ckConvertFromClub=document.getElementById(g.ckConvertFromClub);this.convertFromClub=document.getElementById("convertFromClub");this.ckConvertToClub.checked=SITE.properties.partGen.convertToClub;this.convertToClub.style.display=f?"inline":"none";this.ckConvertFromClub.checked=SITE.properties.partGen.convertFromClub;this.convertFromClub.style.display=a?"inline":"none";this.studioCanvasDiv=document.createElement("DIV");this.studioCanvasDiv.setAttribute("id","t2pStudioCanvasDiv");this.studioCanvasDiv.setAttribute("class","studioCanvasDiv customScrollBar");this.canvasDiv=document.createElement("DIV");this.canvasDiv.setAttribute("id",b);this.canvasDiv.setAttribute("class","canvasDiv");this.studioCanvasDiv.appendChild(this.abcDiv);this.studioCanvasDiv.appendChild(this.canvasDiv);this.renderedTune.div=this.canvasDiv;this.Div.dataDiv.appendChild(this.studioCanvasDiv);this.showMapButton=document.getElementById(g.showMapBtn);this.showEditorButton=document.getElementById(g.showEditorBtn);this.printButton=document.getElementById(g.printBtn);this.saveButton=document.getElementById(g.saveBtn);this.updateButton=document.getElementById(g.updateBtn);this.playButton=document.getElementById(g.playBtn);this.stopButton=document.getElementById(g.stopBtn);this.currentPlayTimeLabel=document.getElementById(g.currentPlayTimeLabel);this.showEditorButton.addEventListener("click",function(h){h.preventDefault();this.blur();d.showEditor()},false);this.showMapButton.addEventListener("click",function(h){h.preventDefault();this.blur();d.showKeyboard()},false);this.updateButton.addEventListener("click",function(){d.fireChanged()},false);this.ckConvertToClub.addEventListener("click",function(){SITE.properties.partGen.convertToClub=!!this.checked;d.fireChanged()},false);this.ckConvertFromClub.addEventListener("click",function(){SITE.properties.partGen.convertFromClub=!!this.checked;d.fireChanged()},false);this.ckShowABC.addEventListener("click",function(){SITE.properties.partGen.showABCText=!!this.checked;d.abcDiv.style.display=this.checked?"":"none"},false);this.printButton.addEventListener("click",function(h){h.preventDefault();this.blur();d.mapa.printPreview(d.renderedTune.div.innerHTML,["#topBar","#mapaDiv","#partGenDiv"],d.renderedTune.abc.formatting.landscape)},false);this.saveButton.addEventListener("click",function(){d.salvaPartitura()},false);this.playerCallBackOnScroll=function(h){d.setScrolling(h)};this.playerCallBackOnPlay=function(h){var i=h.getTime().cTime;if(d.gotoMeasureButton){d.gotoMeasureButton.value=h.currentMeasure}if(d.currentPlayTimeLabel){d.currentPlayTimeLabel.innerHTML=i}};this.playerCallBackOnEnd=function(i){var j=d.midiPlayer.getWarnings();d.playButton.title=DR.getResource("playBtn");d.playButton.innerHTML='&#160;<i class="ico-play"></i>&#160;';d.renderedTune.printer.clearSelection();d.accordion.clearKeyboard(true);if(d.currentPlayTimeLabel){d.currentPlayTimeLabel.innerHTML="00:00.00"}if(j){var h="";j.forEach(function(k){h+=k+"<br>"});d.warningsDiv.style.color="blue";d.warningsDiv.innerHTML="<hr>"+h+"<hr>"}};this.playButton.addEventListener("click",function(){d.startPlay("normal")},false);this.stopButton.addEventListener("click",function(h){h.preventDefault();this.blur();d.midiPlayer.stopPlay();d.editorWindow.setReadOnly(false);d.editorWindow.clearEditorHighLightStyle()},false);this.midiPlayer.defineCallbackOnPlay(d.playerCallBackOnPlay);this.midiPlayer.defineCallbackOnEnd(d.playerCallBackOnEnd);this.midiPlayer.defineCallbackOnScroll(d.playerCallBackOnScroll)};SITE.PartGen.prototype.setup=function(a){this.mapa.closeMapa();this.accordion.loadById(a.accordionId);this.setVisible(true);if(this.editorWindow.getString()===""){var b=FILEMANAGER.loadLocal("ultimaTablaturaEditada");if(!b){b=this.getDemoText()}this.editorWindow.setString(b)}this.warningsDiv.style.display=SITE.properties.options.showWarnings?"block":"none";this.fireChanged();this.editorWindow.restartUndoManager();this.Div.setTitle("-&#160;"+this.accordion.getTxtModel());this.showEditor(SITE.properties.partGen.editor.visible);if(SITE.properties.partGen.editor.floating){if(SITE.properties.partGen.editor.maximized){this.editorWindow.container.dispatchAction("MAXIMIZE")}else{this.editorWindow.container.dispatchAction("POPOUT")}}else{this.editorWindow.container.dispatchAction("POPIN")}this.showKeyboard(SITE.properties.partGen.keyboard.visible);this.keyboardWindow.setTitle(this.accordion.getTxtTuning()+" - "+this.accordion.getTxtNumButtons());this.resize()};SITE.PartGen.prototype.resize=function(){var i=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;var d=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var f=(i-78-10);var a=(d-8);this.Div.topDiv.style.height=Math.max(f,200)+"px";this.Div.topDiv.style.width=Math.max(a,400)+"px";var g=0;var j=this.controlDiv.clientHeight;var b=this.Div.dataDiv.clientHeight;if(!SITE.properties.partGen.editor.floating){g=this.editorWindow.container.topDiv.clientHeight+4}this.studioCanvasDiv.style.height=b-(g+j+6)+"px";this.posicionaTeclado()};SITE.PartGen.prototype.posicionaTeclado=function(){if(!SITE.properties.studio.keyboard.visible){return}var b=window.innerWidth;var c=this.keyboardWindow.topDiv;var a=parseInt(c.style.left.replace("px",""));if(a+c.offsetWidth>b){a=(b-(c.offsetWidth+50))}if(a<0){a=10}c.style.left=a+"px"};SITE.PartGen.prototype.closePartGen=function(c){var b=this;var a=this.mapa.startLoader("ClosePartGen");a.start(function(){var d=b.editorWindow.getString();b.setVisible(false);b.editorWindow.setString("");b.midiPlayer.stopPlay();(c)&&SITE.SaveProperties();if(d!==""){FILEMANAGER.saveLocal("ultimaTablaturaEditada",d)}b.mapa.openMapa();a.stop()},"<br/>&#160;&#160;&#160;"+DR.getResource("DR_wait")+"<br/><br/>")};SITE.PartGen.prototype.showEditor=function(a){SITE.properties.partGen.editor.visible=(typeof a==="undefined"?!SITE.properties.partGen.editor.visible:a);
if(SITE.properties.partGen.editor.visible){this.editorWindow.setVisible(true);document.getElementById("t2pI_showEditor").setAttribute("class","ico-folder-open")}else{document.getElementById("t2pI_showEditor").setAttribute("class","ico-folder");this.editorWindow.setVisible(false)}this.resize()};SITE.PartGen.prototype.showKeyboard=function(a){SITE.properties.partGen.keyboard.visible=(typeof a==="undefined"?!SITE.properties.partGen.keyboard.visible:a);this.accordion.render_opts.show=SITE.properties.partGen.keyboard.visible;if(SITE.properties.partGen.keyboard.visible){this.keyboardWindow.setVisible(true);this.accordion.printKeyboard(this.keyboardWindow.dataDiv);document.getElementById("t2pI_showMap").setAttribute("class","ico-folder-open");this.posicionaTeclado()}else{this.accordion.render_opts.show=false;this.keyboardWindow.setVisible(false);document.getElementById("t2pI_showMap").setAttribute("class","ico-folder")}};SITE.PartGen.prototype.editorCallback=function(b,a){switch(b){case"REFRESH":this.fireChanged();break;case"DOWNLOAD":this.salvaTablatura();break;case"MAXIMIZE":this.editorWindow.maximizeWindow(true,SITE.properties.partGen.editor);break;case"RESTORE":this.editorWindow.maximizeWindow(false,SITE.properties.partGen.editor);break;case"POPIN":this.editorWindow.dockWindow(true,SITE.properties.partGen.editor,0,0,"calc(100% - 5px)","200px");this.resize();break;case"POPOUT":this.editorWindow.dockWindow(false,SITE.properties.partGen.editor);this.resize();break;case"RESIZE":case"MOVE":this.editorWindow.retrieveProps(SITE.properties.partGen.editor);break;case"CLOSE":this.showEditor(false);break}};SITE.PartGen.prototype.t2pCallback=function(a){switch(a){case"CLOSE":this.closePartGen(true);break;case"HELP":this.mapa.showHelp("Ajuda - Gerador de partituras","/diatonic-map/html5/geradorPartitura.pt_BR.html",{width:"1024",height:"600"})}};SITE.PartGen.prototype.setVisible=function(a){this.Div.parent.style.display=a?"block":"none"};SITE.PartGen.prototype.fireChanged=function(){var a=this.editorWindow.getString();if(a!==""){FILEMANAGER.saveLocal("ultimaTablaturaEditada",a);this.renderedTune.text=this.tabParser.parse(a,this.accordion.loadedKeyboard,this.ckConvertToClub.checked,this.ckConvertFromClub.checked);this.printABC()}else{this.editorWindow.container.setTitle("");this.warningsDiv.innerHTML="";this.abcDiv.innerHTML="";this.renderedTune.div.innerHTML=""}};SITE.PartGen.prototype.printABC=function(){this.abcDiv.innerHTML=this.renderedTune.text.replace(/\n/g,"<br>");var a=this.tabParser.getWarnings();if(a){this.warningsDiv.innerHTML=a;this.warningsDiv.style.color="red"}else{this.warningsDiv.innerHTML="Partitura gerada com sucesso!";this.warningsDiv.style.color="green"}this.parseABC();this.renderedTune.printer=new ABCXJS.write.Printer(new SVG.Printer(this.renderedTune.div));this.renderedTune.printer.printABC(this.renderedTune.abc)};SITE.PartGen.prototype.parseABC=function(){var a=null;var b=new ABCXJS.parse.Parse(a,this.accordion);b.parse(this.renderedTune.text,this.parserparams);this.renderedTune.abc=b.getTune();this.renderedTune.title=this.renderedTune.abc.metaText.title;if(this.renderedTune.title){this.editorWindow.container.setTitle("-&#160;"+this.renderedTune.abc.metaText.title)}else{this.editorWindow.container.setTitle("")}if(this.midiParser){this.midiParser.parse(this.renderedTune.abc,this.accordion.loadedKeyboard)}};SITE.PartGen.prototype.highlight=function(a){if(SITE.properties.partGen.editor.visible){this.editorWindow.setSelection(a)}if(SITE.properties.partGen.keyboard.visible&&!this.midiPlayer.playing){this.accordion.clearKeyboard(true);this.midiParser.setSelection(a)}};SITE.PartGen.prototype.unhighlight=function(a){if(SITE.properties.partGen.editor.visible){this.editorWindow.clearSelection(a)}};SITE.PartGen.prototype.updateSelection=function(c){return;var b=this;if(c){var a=b.editorWindow.getSelection();try{b.renderedTune.printer.rangeHighlight(a)}catch(d){}delete this.updating}else{if(this.updating){return}this.updating=true;setTimeout(b.updateSelection(true),300)}};SITE.PartGen.prototype.keyboardCallback=function(b){switch(b){case"MOVE":var a=this.keyboardWindow.topDiv.style;SITE.properties.partGen.keyboard.left=a.left;SITE.properties.partGen.keyboard.top=a.top;break;case"ROTATE":this.accordion.rotateKeyboard(this.keyboardWindow.dataDiv);SITE.properties.partGen.keyboard.transpose=this.accordion.render_opts.transpose;SITE.properties.partGen.keyboard.mirror=this.accordion.render_opts.mirror;break;case"ZOOM":this.accordion.scaleKeyboard(this.keyboardWindow.dataDiv);SITE.properties.partGen.keyboard.scale=this.accordion.render_opts.scale;break;case"GLOBE":this.accordion.changeNotation();SITE.properties.partGen.keyboard.label=this.accordion.render_opts.label;break;case"CLOSE":this.showKeyboard(false);break}};SITE.PartGen.prototype.salvaPartitura=function(){if(FILEMANAGER.requiredFeaturesAvailable()){var a=this.renderedTune.abc.metaText.title+".abcx";var b=this.renderedTune.text;FILEMANAGER.download(a,b)}else{alert(DR.getResource("DR_err_saving"))}};SITE.PartGen.prototype.salvaTablatura=function(){if(FILEMANAGER.requiredFeaturesAvailable()){var a=this.renderedTune.abc.metaText.title+".tab";var b=this.editorWindow.getString();FILEMANAGER.download(a,b)}else{alert(DR.getResource("DR_err_saving"))}};SITE.PartGen.prototype.startPlay=function(a,b){this.ypos=this.studioCanvasDiv.scrollTop;this.lastStaffGroup=-1;if(this.midiPlayer.playing){if(a==="normal"){this.playButton.title=DR.getResource("playBtn");this.playButton.innerHTML='&#160;<i class="ico-play"></i>&#160;';this.midiPlayer.pausePlay()}else{this.midiPlayer.pausePlay(true)}this.editorWindow.setReadOnly(false);this.editorWindow.clearEditorHighLightStyle()}else{this.accordion.clearKeyboard();this.editorWindow.setReadOnly(true);this.editorWindow.setEditorHighLightStyle();if(a==="normal"){if(this.midiPlayer.startPlay(this.renderedTune.abc.midi)){this.playButton.title=DR.getResource("DR_pause");this.playButton.innerHTML='<i class="ico-pause"></i>'}}else{if(this.midiPlayer.startDidacticPlay(this.renderedTune.abc.midi,a,b)){}}}};SITE.PartGen.prototype.setScrolling=function(c){if(!this.studioCanvasDiv||c.currAbsElem.staffGroup===this.lastStaffGroup){return}this.lastStaffGroup=c.currAbsElem.staffGroup;var e=c.printer.staffgroups[0].top;var b=this.studioCanvasDiv.clientHeight-e;var d=c.printer.staffgroups[c.currAbsElem.staffGroup].top;var a=d+c.printer.staffgroups[c.currAbsElem.staffGroup].height;if(a>b+this.ypos||this.ypos>d-e){this.ypos=d;this.studioCanvasDiv.scrollTop=this.ypos}};SITE.PartGen.prototype.getDemoText=function(){return"T:Hino do Grêmio\nC:Lupicínio Rodrigues\nC:(adapt. Cezar Ferreira)\nL:1/8\nQ:140\nM:4/4\nK:C\n|: C c       C  c       | G  g  G g | C c       C  c       | G  g G g       |\n|: 9 7'  8   6' 8   7'  |           | 9 7'  8   6' 8   7'  |                |\n|:                      | 7' 5'   z |                      | 7'   z 9   8'  |\n+  2 1.5 0.5 2  1.5 0.5   2  2  2 2   2 1.5 0.5 2  1.5 0.5   2  2 2 1.5 0.5\n\n| C  z   z   A  z   z   | F   f  F f       | C  g       G  g       | C  c C c :|\n| 8'                    |                  | 8'                    | 6'     z :|\n|    10  9'  11 9'  11  | 10' 11 z 9   8'  |    11  9'  7' 8'  9   |          :|\n+ 2  1.5 0.5 2  1.5 0.5   2   2  2 1.5 0.5   2  1.5 0.5 2  1.5 0.5   2  2 2 2\n"
};if(!window.SITE){window.SITE={}}SITE.TabGen=function(a,d){var b=this;this.mapa=a;this.accordion=a.accordion;var c="p2tWarningsDiv";this.Div=new DRAGGABLE.ui.Window(d.tabGenDiv,null,{translate:false,statusbar:false,draggable:false,top:"3px",left:"1px",width:"100%",height:"100%",title:"Extrair Tablatura"},{listener:this,method:"p2tCallback"});this.Div.setVisible(true);this.Div.dataDiv.style.overflow="hidden";this.controlDiv=document.createElement("DIV");this.controlDiv.setAttribute("id","p2tcontrolDiv");this.controlDiv.setAttribute("class","controlDiv btn-group");this.Div.dataDiv.appendChild(this.controlDiv);this.controlDiv.innerHTML=document.getElementById(d.controlDiv).innerHTML;document.getElementById(d.controlDiv).innerHTML="";this.warningsDiv=document.createElement("DIV");this.warningsDiv.setAttribute("id",c);this.warningsDiv.setAttribute("class","warningsDiv");this.Div.dataDiv.appendChild(this.warningsDiv);this.abcEditorDiv=document.createElement("DIV");this.Div.dataDiv.appendChild(this.abcEditorDiv);this.tabEditorDiv=document.createElement("DIV");this.Div.dataDiv.appendChild(this.tabEditorDiv);this.tabParser=new ABCXJS.Part2Tab();this.abcEditorWindow=new ABCXJS.edit.EditArea(this.abcEditorDiv,{listener:this,method:"abcEditorCallback"},{draggable:SITE.properties.tabGen.abcEditor.floating,toolbar:true,statusbar:true,translate:false,title:"Partitura Original",compileOnChange:false});this.abcEditorWindow.setVisible(true);this.abcEditorWindow.container.setButtonVisible("CLOSE",false);this.abcEditorWindow.container.setButtonVisible("DOWNLOAD",false);this.abcEditorWindow.container.setButtonVisible("OCTAVEUP",false);this.abcEditorWindow.container.setButtonVisible("OCTAVEDOWN",false);this.abcEditorWindow.keySelector.setVisible(false);this.tabEditorWindow=new ABCXJS.edit.EditArea(this.tabEditorDiv,{listener:this,method:"tabEditorCallback"},{draggable:SITE.properties.tabGen.tabEditor.floating,toolbar:true,statusbar:true,translate:false,title:"Tablatura Extraída",compileOnChange:false});this.tabEditorWindow.setVisible(true);this.tabEditorWindow.container.setButtonVisible("CLOSE",false);this.tabEditorWindow.container.setButtonVisible("DOWNLOAD",false);this.tabEditorWindow.container.setButtonVisible("OCTAVEUP",false);this.tabEditorWindow.container.setButtonVisible("OCTAVEDOWN",false);this.tabEditorWindow.keySelector.setVisible(false);this.saveButton=document.getElementById(d.saveBtn);this.updateButton=document.getElementById(d.updateBtn);this.openButton=document.getElementById(d.openBtn);this.updateButton.addEventListener("click",function(){b.fireChanged()},false);this.saveButton.addEventListener("click",function(){b.salvaTablatura()},false);this.openButton.addEventListener("click",function(){var e=b.tabEditorWindow.getString();b.setVisible(false);SITE.SaveProperties();if(e!==""){FILEMANAGER.saveLocal("ultimaTablaturaEditada",e);b.mapa.menu.dispatchAction("menuRepertorio","TAB2PART")}},false)};SITE.TabGen.prototype.setup=function(a){this.mapa.closeMapa();this.setVisible(true);this.abcEditorWindow.setString(a);if(SITE.properties.tabGen.abcEditor.floating){if(SITE.properties.tabGen.abcEditor.maximized){this.abcEditorWindow.container.dispatchAction("MAXIMIZE")}else{this.abcEditorWindow.container.dispatchAction("POPOUT")}}else{this.abcEditorWindow.container.dispatchAction("POPIN")}this.warningsDiv.style.display=SITE.properties.options.showWarnings?"block":"none";this.fireChanged();if(SITE.properties.tabGen.tabEditor.floating){if(SITE.properties.tabGen.tabEditor.maximized){this.tabEditorWindow.container.dispatchAction("MAXIMIZE")}else{this.tabEditorWindow.container.dispatchAction("POPOUT")}}else{this.tabEditorWindow.container.dispatchAction("POPIN")}this.tabEditorWindow.restartUndoManager();this.resize()};SITE.TabGen.prototype.setVisible=function(a){this.Div.parent.style.display=a?"block":"none"};SITE.TabGen.prototype.fireChanged=function(){this.title="";var a=this.tabParser.parse(this.abcEditorWindow.getString(),this.accordion.loadedKeyboard);this.title=this.tabParser.title;this.printTablature(a)};SITE.TabGen.prototype.salvaTablatura=function(){if(FILEMANAGER.requiredFeaturesAvailable()){var a=this.title+".tab";var b=this.tabEditorWindow.getString();FILEMANAGER.download(a,b)}else{alert(DR.getResource("DR_err_saving"))}};SITE.TabGen.prototype.printTablature=function(b){this.tabEditorWindow.setString(b);var a=this.tabParser.getWarnings();if(a){this.warningsDiv.innerHTML=a;this.warningsDiv.style.color="red"}else{this.warningsDiv.innerHTML="Tablatura extraída com sucesso!";this.warningsDiv.style.color="green"}};SITE.TabGen.prototype.resize=function(){var d=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight;var b=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth;var c=(d-78-10);var a=(b-8);this.Div.topDiv.style.height=Math.max(c,200)+"px";this.Div.topDiv.style.width=Math.max(a,400)+"px"};SITE.TabGen.prototype.updateSelection=function(a){return};SITE.TabGen.prototype.p2tCallback=function(a){switch(a){case"CLOSE":this.setVisible(false);SITE.SaveProperties();this.mapa.openMapa();break}};SITE.TabGen.prototype.tabEditorCallback=function(a){switch(a){case"REFRESH":this.fireChanged();break;case"MAXIMIZE":this.tabEditorWindow.maximizeWindow(true,SITE.properties.tabGen.tabEditor);break;case"RESTORE":this.tabEditorWindow.maximizeWindow(false,SITE.properties.tabGen.tabEditor);break;case"POPIN":this.tabEditorWindow.dockWindow(true,SITE.properties.tabGen.tabEditor,0,0,"calc(100% - 5px)","400px");this.resize();break;case"POPOUT":this.tabEditorWindow.dockWindow(false,SITE.properties.tabGen.tabEditor);this.resize();break;case"RESIZE":case"MOVE":this.tabEditorWindow.retrieveProps(SITE.properties.tabGen.tabEditor);break}};SITE.TabGen.prototype.abcEditorCallback=function(a){switch(a){case"REFRESH":this.fireChanged();break;case"MAXIMIZE":this.abcEditorWindow.maximizeWindow(true,SITE.properties.tabGen.abcEditor);break;case"RESTORE":this.abcEditorWindow.maximizeWindow(false,SITE.properties.tabGen.abcEditor);break;case"POPIN":this.abcEditorWindow.dockWindow(true,SITE.properties.tabGen.abcEditor,0,0,"calc(100% - 5px)","400px");this.resize();break;case"POPOUT":this.abcEditorWindow.dockWindow(false,SITE.properties.tabGen.abcEditor);this.resize();break;case"RESIZE":case"MOVE":this.abcEditorWindow.retrieveProps(SITE.properties.tabGen.abcEditor);break}};if(!window.ABCXJS){window.ABCXJS={}}String.prototype.replaceAll=function(a,b){var c=this;return c.replace(new RegExp(a,"g"),b)};ABCXJS.Tab2PartLine=function(){this.basses=[];this.treble="";this.tablature=""};ABCXJS.Tab2Part=function(b,a){this.toClub=b||false;this.fromClub=a||false;this.ties=[];this.keyAcidentals=[];this.barAccidentals=[];this.barBassAccidentals=[];this.startSyms="|/+%";this.barSyms=":]|[";this.spaces="-. \t";this.bassOctave=2;this.init();this.addWarning=function(c){this.warnings.push(c)};this.getWarnings=function(){return this.warnings.join("<br>")}};ABCXJS.Tab2Part.prototype.init=function(){this.tabText;
this.tabLines;this.endColumn=0;this.startColumn=null;this.durationLine=null;this.columnDuration="";this.barEnding=false;this.trebleStaffs={open:null,close:null};this.parsedLines=[];this.currLine=0;this.abcText="";this.updateBarNumberOnNextNote=false;this.alertedBarNumber=0;this.currBar=0;this.currStaff=-1;this.warnings=[]};ABCXJS.Tab2Part.prototype.parse=function(d,a,e,b){this.init();this.tabText=d;this.tabLines=this.extractLines();this.keyboard=a;this.hasErrors=false;this.toClub=e;this.fromClub=b;this.addLine("%%barnumbers 1");this.addLine("%%papersize A4");while((!this.hasErrors)&&this.currLine<this.tabLines.length){if(this.skipEmptyLines()){this.parseLine();this.currLine++}}if(!this.hasErrors){this.addLine("V:1 treble");var c="";this.parsedLines.forEach(function(f){c+=f.treble+"\n"});this.addLine(c.slice(0,-1));this.addLine("V:2 bass");var c="";this.parsedLines.forEach(function(f){c+=f.basses[0]+"\n"});this.addLine(c.slice(0,-1));this.addLine("V:3 accordionTab");c="";this.parsedLines.forEach(function(f){c+=f.tablature+"\n"});this.addLine(c.slice(0,-1))}return this.abcText};ABCXJS.Tab2Part.prototype.extractLines=function(){var a=this.tabText.split("\n");a.forEach(function(c,d){var b=c.split("%");a[d]=b[0].trim()});return a};ABCXJS.Tab2Part.prototype.parseLine=function(){var c=this.tabLines[this.currLine].match(/^([CKLMTQ]\:*[^\r\n\t\%]*)/g);if(c){var b=this.tabLines[this.currLine].match(/^([CKLMTQ]\:)/g);switch(b[0]){case"K:":var a=ABCXJS.parse.denormalizeAcc(c[0].trim().substr(2));if(this.toClub){switch(a){case"G":a="C";break;case"Am":a="Dm";break;case"C":a="F"}}else{if(this.fromClub){switch(a){case"C":a="G";break;case"Dm":a="Am";break;case"F":a="C"}}}c[0]="K:"+a;this.keyAcidentals=ABCXJS.parse.parseKeyVoice.standardKey(a);break}this.addLine(c[0])}else{this.parseStaff()}};ABCXJS.Tab2Part.prototype.skipEmptyLines=function(){while(this.currLine<this.tabLines.length){if(this.tabLines[this.currLine].charAt(0)!=="%"&&this.tabLines[this.currLine].match(/^[\s\r\t]*$/)===null){return true}this.currLine++}return false};ABCXJS.Tab2Part.prototype.addLine=function(a){this.abcText+=a+"\n"};ABCXJS.Tab2Part.prototype.parseStaff=function(){var c=this.idStaff();var a=1;var b=1000;while(a>0&&--b){this.posiciona(c);a=this.read(c);switch(a){case 1:this.addBar(c,c[0].token.str);break;case 2:this.addNotes(c);break}}if(!b){this.addWarning("Não pude processar tablatura após 1000 ciclos. Possivel desalinhamento de texto.");this.hasErrors=true}};ABCXJS.Tab2Part.prototype.addBar=function(c,d){var a=true;this.addTabElem(d+" ");for(var b=0;b<c.length;b++){if(c[b].st!=="closed"){if(c[b].bass){this.addBassElem(c[b].idBass,d+" ")}else{if(a){this.addTrebleElem(d+" ");a=false}}this.setStaffState(c[b])}}};ABCXJS.Tab2Part.prototype.addNotes=function(d){var f;var a=true;var k=true;var g=false;for(var c=0;k&&c<d.length;c++){if(d[c].st==="processing"&&!d[c].bass){a=d[c].open;k=false;g=true}}if(!g){if(this.alertedBarNumber!==d[0].token.barNumber){this.addWarning("Compasso "+d[0].token.barNumber+": Pelo menos uma pausa deveria ser adicionada à melodia!.");this.alertedBarNumber=d[0].token.barNumber}}k=true;for(var c=0;c<d.length;c++){if(d[c].st==="processing"){if(d[c].bass){var h=this.handleBassNote(d[c].token.str);if(d[c].token.added&&h.pitch!=="z"){f=">"}else{d[c].token.added=true;f=h.pitch}this.addTabElem(f);if(d[c].token.afinal){var e=this.checkBass(h.pitch,a);if(!e){if(this.alertedBarNumber!==d[c].token.barNumber){this.addWarning("Compasso "+d[c].token.barNumber+": Baixo não encontrado ou não compatível com o movimento do fole.");this.alertedBarNumber=d[c].token.barNumber}}this.addBassElem(d[c].idBass,d[c],e);this.setStaffState(d[c])}}else{if(k){this.addTabElem(a?"-":"+");k=false}f="";for(var b=0;b<d[c].token.aStr.length;b++){if(d[c].token.added&&d[c].token.aStr[b]!=="z"){f+=">"}else{f+=this.toHex(d[c].token.aStr[b])}}d[c].token.added=true;if(d[c].token.aStr.length>1){f="["+f+"]"}if((a&&d[c].open)||(!a&&!d[c].open)){if(this.ties.length>0){var l=this.ties.pop();if(l!==f){this.ties.push(l)}else{f="";for(var b=0;b<d[c].token.aStr.length;b++){f+=">"}if(d[c].token.aStr.length>1){f="["+f+"]"}}}else{if(d[c].token.lastChar.indexOf("-")>=0){this.ties.push(f)}}this.addTabElem(f);if((this.trebleStaffs.open&&this.trebleStaffs.open.token.afinal)||(this.trebleStaffs.close&&this.trebleStaffs.close.token.afinal)){this.addTrebleElem(d[c]);if(this.trebleStaffs.open){this.setStaffState(this.trebleStaffs.open);this.trebleStaffs.open.token.afinal=true}if(this.trebleStaffs.close){this.setStaffState(this.trebleStaffs.close);this.trebleStaffs.close.token.afinal=true}}}else{if(this.alertedBarNumber!==d[c].token.barNumber){this.addWarning("Compasso "+d[c].token.barNumber+": Não é possível ter ambos (abrindo e fechando) movimento de fole.");this.alertedBarNumber=d[c].token.barNumber}}}}}if(this.columnDuration&&this.columnDuration.length){this.addTabElem(this.columnDuration)}this.addTabElem(" ")};ABCXJS.Tab2Part.prototype.addTabElem=function(a){this.parsedLines[this.currStaff].tablature+=a};ABCXJS.Tab2Part.prototype.handleBassNote=function(b){var a=false,d=false,c=false;if("@XxZz".indexOf(b.charAt(0))>0){c=true}if(b.charAt(b.length-1)==="m"){d=true;b=b.slice(0,-1)}if(b===b.toLowerCase()){a=true}return{pitch:b,isRest:c,isMinor:d,isChord:a}};ABCXJS.Tab2Part.prototype.addBassElem=function(a,d,c){if(typeof(d)==="string"){this.parsedLines[this.currStaff].basses[a]+=d}else{if(d.hasToken&&d.token.afinal){var b=this.handleBassNote(d.token.str);var e;if(b.isRest){e=b.pitch}else{if(b.isChord){e=this.getChord(b.pitch,(c.isMinor!==undefined?c.isMinor:b.isMinor))}else{e=this.getTabNote(b.pitch,this.bassOctave,true)}}e+=(d.token.duration!==1?d.token.duration:"")+(d.token.lastChar.indexOf("-")>=0?"-":"")+(d.token.lastChar.indexOf(".")>=0?"":" ");this.parsedLines[this.currStaff].basses[a]+=e}}};ABCXJS.Tab2Part.prototype.addTrebleElem=function(a){var b;if(typeof(a)==="string"){this.parsedLines[this.currStaff].treble+=a}else{b=this.getPitch(a);b+=(a.token.duration!==1?a.token.duration:"")+(a.token.lastChar.indexOf("-")>=0?"-":"")+(a.token.lastChar.indexOf(".")>=0?"":" ");this.parsedLines[this.currStaff].treble+=b}};ABCXJS.Tab2Part.prototype.getPitch=function(e){var c="";for(var d=0;d<e.token.aStr.length;d++){var f=e.token.aStr[d];if(f!=="z"){var a=this.getButton(f);if(a){var g=e.open?a.openNote:a.closeNote;f=this.getTabNote(g.key,g.octave,false)}}c+=f}return e.token.aStr.length>1?"["+c+"]":c};ABCXJS.Tab2Part.prototype.getChord=function(g,f){var e=ABCXJS.parse.normalizeAcc(g.toUpperCase());var d=ABCXJS.parse.key2number[e];if(!(d>=0)){throw new Error("Acorde não identificado: "+e)}var c=d+(f?3:4);var b=d+7;var a=this.bassOctave+(d>4?0:1);return"["+this.getTabNote(ABCXJS.parse.number2keysharp[d%12],a,true)+this.getTabNote(ABCXJS.parse.number2keysharp[c%12],a+Math.trunc(c/12),true)+this.getTabNote(ABCXJS.parse.number2keysharp[b%12],a+Math.trunc(b/12),true)+"]"};ABCXJS.Tab2Part.prototype.getTabNote=function(j,k,f){var h=j.match(/[♯♭]/g);var c=h?j.charAt(0):j;
var l=this.getKeyAccOffset(c);if(h&&l===null){var d,b,g,e,a=ABCXJS.parse.key2number[j];if(h[0]==="♯"){d=ABCXJS.parse.number2keyflat[a%12]}else{d=ABCXJS.parse.number2keysharp[a%12]}b=d.match(/[♯♭]/g);g=d.charAt(0);e=this.getKeyAccOffset(g);if(e){j=d;c=g;l=e;h=b}}if(h){if((h[0]==="♯"&&l==="sharp")||(h[0]==="♭"&&l==="flat")){}else{c=((h[0]==="♯")?"^":"_")+c}}else{if(l){c="="+c}}if(f){if(h){if(this.barBassAccidentals[c]){if(this.barBassAccidentals[c]===h[0]){c=c.charAt(1)}}else{this.barBassAccidentals[c.charAt(1)]=h[0]}}else{if(this.barBassAccidentals[c]){c="="+c}}}else{if(h){if(this.barAccidentals[c]){if(this.barAccidentals[c]===h[0]){c=c.charAt(1)}}else{this.barAccidentals[c.charAt(1)]=h[0]}}else{if(this.barAccidentals[c]){c="="+c}}}var i=c;if(k<4){i=c+Array(5-k).join(",")}else{if(k===5){i=c.toLowerCase()}else{if(k>5){i=c.toLowerCase()+Array(k-4).join("'")}}}return i};ABCXJS.Tab2Part.prototype.setStaffState=function(a){a.hasToken=false;a.st=(a.linhas[0].pos<this.tabLines[a.linhas[0].l].length?"waiting for data":"closed")};ABCXJS.Tab2Part.prototype.idStaff=function(){var b=[],f=-1,h=true,m=-1,g=0,n=0;this.endColumn=0;this.startColumn=null;this.durationLine=null;this.columnDuration=null;this.trebleStaffs={open:null,close:null};this.parsedLines[++this.currStaff]=new ABCXJS.Tab2PartLine();while(this.currLine<this.tabLines.length&&this.tabLines[this.currLine].trim().length&&this.startSyms.indexOf(this.tabLines[this.currLine].charAt(0))>=0){var a=true;switch(this.tabLines[this.currLine].charAt(0)){case"|":if(this.tabLines[this.currLine].match(/[ABCDFEGabcdefg]/)){b[++f]={hasToken:false,bass:true,idBass:++m,linhas:[{l:this.currLine,pos:0}],st:"waiting for data"};this.parsedLines[this.currStaff].basses[m]=""}else{h=!h;b[++f]={hasToken:false,bass:false,open:h,linhas:[{l:this.currLine,pos:0}],st:"waiting for data"};if(h){this.trebleStaffs.open=b[f]}else{this.trebleStaffs.close=b[f]}}break;case"/":b[f].linhas.push({l:this.currLine,pos:0});break;case"+":a=false;this.durationLine=this.currLine;break;case"%":a=false;break}if(a&&g<this.tabLines[this.currLine].length){g=this.tabLines[this.currLine].length;n=this.currLine}this.currLine++}var d=0,c;while((c=(this.tabLines[n].substr(d+1).indexOf("|")))>0){d+=c+1;for(var e=0;e<b.length;e++){var o=b[e];for(var f=0;f<o.linhas.length;f++){var c=this.tabLines[o.linhas[f].l];if(c.length>d&&c.charAt(d)!=="|"){this.addWarning("Possível falta de sincronismo na pauta "+(this.currStaff+1)+", linha "+(e+1)+", coluna "+(d+1)+". Barras desalinhadas.")}}}}return b};ABCXJS.Tab2Part.prototype.posiciona=function(f){var g=false;var h=0;this.startColumn=this.endColumn;this.barEnding=false;while(!g){g=true;for(var c=0;g&&c<f.length;c++){var a=f[c];h+=a.linhas.length;for(var d=0;g&&d<a.linhas.length;d++){var b=this.tabLines[a.linhas[d].l];if(this.endColumn<b.length&&this.spaces.indexOf(b.charAt(this.endColumn))<0){g=false;this.endColumn++}}}}this.endColumn++;g=false;while(!g){for(var c=0;!g&&c<f.length;c++){var a=f[c];h+=a.linhas.length;for(var d=0;!g&&d<a.linhas.length;d++){var b=this.tabLines[a.linhas[d].l];if(this.endColumn>=b.length||this.spaces.indexOf(b.charAt(this.endColumn))<0){if(b.charAt(this.endColumn)&&this.barSyms.indexOf(b.charAt(this.endColumn))>=0){this.barEnding=true}g=true}}}if(!g){this.endColumn++}}if(this.durationLine&&this.durationLine>=0){var e=this.tabLines[this.durationLine].substr(this.startColumn,this.endColumn-this.startColumn).trim();this.columnDuration=e.length>0?e:""}};ABCXJS.Tab2Part.prototype.read=function(d){var c=0,b=0;for(var a=0;a<d.length;a++){var e=d[a];switch(e.st){case"waiting for data":e.token=this.getToken(e);if(e.hasToken){e.st=(e.token.type==="bar")?"waiting end of interval":"processing";b=(e.token.type==="bar")?1:2}else{b=2}break;case"waiting end of interval":b=1;break;case"closed":b=0;break;case"processing":this.updateToken(e);b=2;break}c=Math.max(b,c)}return c};ABCXJS.Tab2Part.prototype.getToken=function(s){var g="():|[]/";var q=s.linhas.length;var u=false;var m=null;var r="";var l=[];var d="";this.skipSyms(s,this.spaces);for(var h=0;h<q;h++){var e="";var n=s.linhas[h];var t=false;while(n.pos<Math.min(this.tabLines[n.l].length,this.endColumn)&&!t){var k=this.tabLines[n.l].charAt(n.pos);if(k!==" "&&k!=="."&&k!=="-"){e+=k;n.pos++}else{if(g.indexOf(e.charAt(0))>=0){for(var f=1;f<q;f++){s.linhas[f].pos=n.pos}q=1}else{r+=k}t=true}}if(e.trim().length>0){if(this.toClub&&g.indexOf(e.charAt(0))<0&&e!=="z"){if(s.bass){switch(e){case"C":e="F";break;case"c":e="f";break;case"D":e="G";break;case"d":e="g";break;case"E":e="A";break;case"e":e="a";break;case"F":e="B♭";break;case"f":e="b♭";break;case"G":e="C";break;case"g":e="c";break;case"A":e="D";break;case"a":e="d";break}}else{var p=e.match(/^[0-9]*/g);var o=e.replace(p[0],"");e=(parseInt(p[0])+1)+o}}if(this.fromClub&&g.indexOf(e.charAt(0))<0&&e!=="z"){if(s.bass){switch(e){case"A":e="E";break;case"a":e="e";break;case"B♭":e="F";break;case"b♭":e="f";break;case"C":e="G";break;case"c":e="g";break;case"D":e="A";break;case"d":e="a";break;case"F":e="C";break;case"f":e="c";break;case"G":e="D";break;case"g":e="d";break}}else{var p=e.match(/^[0-9]*/g);var o=e.replace(p[0],"");e=(parseInt(p[0])-1)+o}}l.push(e);d+=e}if(this.barEnding||n.pos>=this.tabLines[n.l].length||this.spaces.indexOf(this.tabLines[n.l].charAt(this.endColumn))<0){u=true}}s.hasToken=d.trim().length!==0;if(s.hasToken){if(g.indexOf(d.charAt(0))>=0){if(d.charAt(0)==="("||d.charAt(0)===")"){m="triplet"}else{m="bar";this.barAccidentals=[];this.barBassAccidentals=[];this.updateBarNumberOnNextNote=true}}else{m="note";d=this.normalizeAcc(d);if(this.updateBarNumberOnNextNote){this.updateBarNumberOnNextNote=false;this.currBar++}if(l.length>1){d="["+d+"]"}}}var b=1;if(this.columnDuration&&this.columnDuration.length){b=parseFloat(this.columnDuration)}return{str:d,aStr:l,duration:b,barNumber:this.currBar,type:m,afinal:u,added:false,lastChar:r}};ABCXJS.Tab2Part.prototype.normalizeAcc=function(b){var a=b.charAt(0);if(b.length>1){a+=b.substr(1).replace(new RegExp("#","g"),"♯").replace(new RegExp("b","g"),"♭")}return a};ABCXJS.Tab2Part.prototype.updateToken=function(a){var b=false;var f=a.linhas.length;for(var c=0;c<f;c++){var e=a.linhas[c];if(this.barEnding||e.pos>=this.tabLines[e.l].length||this.spaces.indexOf(this.tabLines[e.l].charAt(this.endColumn))<0){b=true}}var d=1;if(this.columnDuration&&this.columnDuration.length){d=parseFloat(this.columnDuration)}a.token.duration+=d;if(b){a.token.afinal=true}};ABCXJS.Tab2Part.prototype.skipSyms=function(a,c){for(var b=0;b<a.linhas.length;b++){while(a.linhas[b].pos<Math.min(this.tabLines[a.linhas[b].l].length,this.endColumn)&&c.indexOf(this.tabLines[a.linhas[b].l].charAt(a.linhas[b].pos))>=0){a.linhas[b].pos++}}};ABCXJS.Tab2Part.prototype.getButton=function(a){if(a==="x"||a===" "||a===""||!this.keyboard){return null}var d=this.keyboard;var e=parseInt(isNaN(a.substr(0,2))||a.length===1?1:2);var c=a.substr(0,e)-1;var f=a.length-e;if(d.keyMap[f][c]){return d.keyMap[f][c]}return null};ABCXJS.Tab2Part.prototype.checkBass=function(c,a){if(c==="-->"||!this.keyboard){return false
}if(c==="z"){return true}var g=this.keyboard;var h=g.parseNote(c,true);for(var d=g.keyMap.length;d>g.keyMap.length-2;d--){for(var e=0;e<g.keyMap[d-1].length;e++){var f=g.keyMap[d-1][e];if((a&&f.openNote.key===h.key)||(!a&&f.closeNote.key===h.key)){return a?f.openNote:f.closeNote.key}}}return false};ABCXJS.Tab2Part.prototype.toHex=function(c){if(c==="z"||c===">"){return c}var d=c.indexOf("'");var b=c.substr(0,d);var a=c.substr(d);return(d<0)?parseInt(c).toString(16):parseInt(b).toString(16)+a};ABCXJS.Tab2Part.prototype.getKeyAccOffset=function(c){for(var b=0;b<this.keyAcidentals.length;b++){if(this.keyAcidentals[b].note.toLowerCase()===c.toLowerCase()){return this.keyAcidentals[b].acc}}return null};function toDecimalNote(b){var a;switch(b){case">":a=" ";break;case"z":a="z";break;default:a=parseInt(b,16)}return a}function regexp_match(c,b){var a,d=[];while((a=b.exec(c))!==null){d.push(a);if(a.index===b.lastIndex){b.lastIndex++}}return d}function lpad(d,f,e){if(!d||!f||d.length>=e){return d}var a=(e-d.length)/f.length;for(var b=0;b<a;b++){d=f+d}return d}function rpad(d,f,e){if(!d||!f||d.length>=e){return d}var a=(e-d.length)/f.length;for(var b=0;b<a;b++){d+=f}return d}if(!window.ABCXJS){window.ABCXJS={}}ABCXJS.Part2TabLine=function(){this.basses="";this.sparring="";this.close=[""];this.open=[""];this.duration="";this.pos=0};ABCXJS.Part2Tab=function(){this.validBars={"|":"bar_thin","||":"bar_thin_thin","[|":"bar_thick_thin","|]":"bar_thin_thick",":|:":"bar_dbl_repeat",":||:":"bar_dbl_repeat","::":"bar_dbl_repeat","|:":"bar_left_repeat","||:":"bar_left_repeat","[|:":"bar_left_repeat",":|":"bar_right_repeat",":||":"bar_right_repeat",":|]":"bar_right_repeat"};this.validBasses="abcdefgABCDEFGz>";this.startSyms="[|:";this.spaces=" \t";this.init();this.addWarning=function(a){this.warnings.push(a)};this.getWarnings=function(){return this.warnings.join("<br>")}};ABCXJS.Part2Tab.prototype.init=function(){this.partText;this.partLines;this.parsedLines=[];this.currLine=0;this.tabText="";this.currBar=0;this.warnings=[];this.inTab=false};ABCXJS.Part2Tab.prototype.parse=function(b,a){this.init();this.partText=b;this.partLines=this.extractLines();this.keyboard=a;this.hasErrors=false;this.title=undefined;while((!this.hasErrors)&&this.currLine<this.partLines.length){if(this.skipEmptyLines()){this.parseLine();this.currLine++}}return this.tabText};ABCXJS.Part2Tab.prototype.extractLines=function(){var a=this.partText.split("\n");a.forEach(function(c,d){var b=c.split("%");a[d]=b[0].trim()});return a};ABCXJS.Part2Tab.prototype.parseLine=function(){var f=this.partLines[this.currLine].match(/^([CKLMTQV]\:*[^\r\n\t\%]*)/g);if(f){var c=this.partLines[this.currLine].match(/^([CKLMTQV]\:)/g);switch(c[0]){case"V:":var a=f[0].match(/accordionTab/g);if(a!==null){this.inTab=true}break;case"T:":if(!this.title){this.title=ABCXJS.parse.denormalizeAcc(f[0].trim().substr(2))}break;case"K:":var b=ABCXJS.parse.denormalizeAcc(f[0].trim().substr(2));f[0]="K:"+b;this.keyAcidentals=ABCXJS.parse.parseKeyVoice.standardKey(b);break}if(c[0]!=="V:"){this.addLine(f[0])}}else{if(this.inTab){var e=this.parseTab();this.addLine(e.basses);for(var d=0;d<e.close.length;d++){this.addLine(e.close[d])}for(var d=0;d<e.open.length;d++){this.addLine(e.open[d])}this.addLine(e.duration+"\n")}}};ABCXJS.Part2Tab.prototype.parseTab=function(){var a={str:this.partLines[this.currLine],posi:0,pos:0,tokenType:1,currToken:""};var c=new ABCXJS.Part2TabLine();if(a.length===0){this.hasErrors=true;return}var b=1000;while(a.tokenType>0&&--b){this.getToken(a);switch(a.tokenType){case 1:this.addBar(c,a.currToken);break;case 2:this.addNotes(c,a);break}}if(a.tokenType<0){this.addWarning("Encontrados simbolos inválidos na linha ("+this.currLine+","+a.posi+") .");this.hasErrors=true}if(!b){this.addWarning("Não pude processar tablatura após 1000 ciclos. Possivel desalinhamento de texto.");this.hasErrors=true}return c};ABCXJS.Part2Tab.prototype.addBar=function(d,b){var a=b.length;d.basses+=b+" ";for(var c=0;c<d.close.length;c++){d.close[c]+=b+" "}for(var c=0;c<d.open.length;c++){d.open[c]+=b+" "}if(d.pos===0){d.sparring+="/"+rpad(" "," ",a);d.duration="+"+rpad(" "," ",a)}else{d.sparring+=b+" ";d.duration+=rpad(" "," ",a+1)}d.pos+=(a+1)};ABCXJS.Part2Tab.prototype.addNotes=function(c,j){var h=j.parsedNotes;if(h.empty&&(j.parsedNotes.bas.trim().length===0||j.parsedNotes.currBar!==j.lastParsedNotes.currBar)){j.lastParsedNotes.currBar=j.parsedNotes.currBar;var f=j.lastParsedNotes.notes;if(h.closing){var e=c.close[0].lastIndexOf(f[0])+j.lastParsedNotes.maxL;for(var a=0;a<c.close.length;a++){var g=c.close[a];if(a<h.notes.length){var b=g.lastIndexOf(f[a]);c.close[a]=g.slice(0,b)+g.slice(b).replace(f[a],f[a]+"-")}else{c.close[a]=g.slice(0,e)+" "+g.slice(e)}}for(var a=0;a<c.open.length;a++){var g=c.open[a];c.open[a]=g.slice(0,e)+" "+g.slice(e)}}else{var e=c.open[0].lastIndexOf(f[0])+j.lastParsedNotes.maxL;for(var a=0;a<c.open.length;a++){var g=c.open[a];if(a<h.notes.length){var b=g.lastIndexOf(f[a]);c.open[a]=g.slice(0,b)+g.slice(b).replace(f[a],f[a]+"-")}else{c.open[a]=g.slice(0,e)+" "+g.slice(e)}}for(var a=0;a<c.close.length;a++){var g=c.close[a];c.close[a]=g.slice(0,e)+" "+g.slice(e)}}c.duration=c.duration.slice(0,e)+" "+c.duration.slice(e);c.sparring=c.sparring.slice(0,e)+" "+c.sparring.slice(e);c.basses=c.basses.slice(0,e)+" "+c.basses.slice(e);j.parsedNotes=window.ABCXJS.parse.clone(j.lastParsedNotes);h.notes=f;h.maxL=Math.max(h.maxL,j.lastParsedNotes.maxL)}var d=h.maxL+1;c.basses+=h.bas+rpad(" "," ",d-h.bas.length);if(h.closing){while(c.close.length<h.notes.length){c.close.push(window.ABCXJS.parse.clone(c.sparring))}for(var a=0;a<c.close.length;a++){if(a<h.notes.length){c.close[a]+=h.notes[a]+rpad(" "," ",d-h.notes[a].length)}else{c.close[a]+=rpad(" "," ",d)}}for(var a=0;a<c.open.length;a++){c.open[a]+=rpad(" "," ",d)}}else{while(c.open.length<h.notes.length){c.open.push(window.ABCXJS.parse.clone(c.sparring))}for(var a=0;a<c.open.length;a++){if(a<h.notes.length){c.open[a]+=h.notes[a]+rpad(" "," ",d-h.notes[a].length)}else{c.open[a]+=rpad(" "," ",d)}}for(var a=0;a<c.close.length;a++){c.close[a]+=rpad(" "," ",d)}}c.sparring+=rpad(" "," ",d);if(h.duration==="1"||h.duration===""){c.duration+=rpad(" "," ",d)}else{c.duration+=h.duration+rpad(" "," ",d-h.duration.length)}c.pos+=d};ABCXJS.Part2Tab.prototype.getNotes=function(a,e,i){var o,c=[],j,m,k,h=0;k=a.match(/(A|B|C|D|E|F|G|z|>)[(♭|♯)]{0,1}/gi);if(k.length<1){return null}else{k[0]=k[0]===">"?" ":k[0];h=Math.max(h,k[0].length)}o=regexp_match(e,/\[(.*?)\](\d{0,1}[\.|\/]{0,1}\d{0,2})/gi);if(o.length===1){j=o[0][2];h=Math.max(h,j.length);m=regexp_match(o[0][1],/(\>|z|[a-f]|[0-9])(\'{0,})/gi);m.forEach(function(d){var b=toDecimalNote(d[1])+d[2];c.push(b);h=Math.max(h,b.length)})}else{o=regexp_match(e,/(\>|z|[a-f]|[0-9])(\'{0,})(\d{0,1}[\.|\/]{0,1}\d{0,2})/gi);if(o.length===1){c.push(toDecimalNote(o[0][1])+o[0][2]);h=Math.max(h,c[0].length);j=o[0][3];h=Math.max(h,j.length)}else{return null}}var f={bas:k[0],notes:c,duration:j,closing:i,maxL:h,currBar:this.currBar,empty:false};
var g=" ";f.notes.forEach(function(b){g+=b});if(g.trim().length===0){f.empty=true}return f};ABCXJS.Part2Tab.prototype.parseNotes=function(c){var a,b;if(c.indexOf("+")>0){a=c.split("+");b=this.getNotes(a[0],a[1],true)}else{a=c.split("-");b=this.getNotes(a[0],a[1],false)}return b};ABCXJS.Part2Tab.prototype.getToken=function(a){var b=false;var d="";this.skipSyms(a,this.spaces);a.currToken="";a.tokenType=0;a.posi=a.pos;while(a.pos<a.str.length&&!b){d=a.str.charAt(a.pos);if(d===" "){b=true;continue}if(a.tokenType===0){if(this.validBars[d]){a.tokenType=1}else{if(this.validBasses.indexOf(d)>=0){a.tokenType=2}else{if(this.startSyms.indexOf(d)<0){a.tokenType=-1}}}}else{switch(a.tokenType){case 1:if(!d.match(/(\||\d|\:|\])/g)){b=true;continue}break;case 2:if(d.match(/(\||\:)/g)){b=true;continue}break}}a.currToken+=d;a.pos++;if(a.tokenType===1){this.currBar++}}if(b&&a.tokenType===2){if(a.parsedNotes!==undefined&&!a.parsedNotes.empty){a.lastParsedNotes=a.parsedNotes}a.parsedNotes=this.parseNotes(a.currToken);if(a.parsedNotes===null){a.tokenType=-1}}};ABCXJS.Part2Tab.prototype.skipSyms=function(a,b){while(a.pos<a.str.length&&b.indexOf(a.str.charAt(a.pos))>=0){a.pos++}};ABCXJS.Part2Tab.prototype.skipEmptyLines=function(){while(this.currLine<this.partLines.length){if(this.partLines[this.currLine].charAt(0)!=="%"&&this.partLines[this.currLine].match(/^[\s\r\t]*$/)===null){return true}this.currLine++}return false};ABCXJS.Part2Tab.prototype.addLine=function(a){this.tabText+=a+"\n"};